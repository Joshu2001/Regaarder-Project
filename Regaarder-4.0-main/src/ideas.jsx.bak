import React, { useState, useEffect, useRef } from "react";
import {
  Home,
  Pencil,
  MoreHorizontal,
  ChevronLeft,
  ChevronRight,
  User,
  ArrowRight,
  FileText,
  Clock,
  Check,
  Lightbulb,
  Film,
  Repeat,
  ListVideo,
  Folder,
  Settings,
  DollarSign,
  Briefcase,
  Coffee,
  TrendingUp,
  Smile,
  Heart,
  BookOpen,
  Crown,
  Link as LinkIcon,
  Globe,
  EyeOff,
  Lock,
  Calendar,
  X,
  MessageCircle,
  Zap,
  Bookmark,
  MessageSquare,
  ChevronsUp,
  Pin,
  HeartOff,
  Flag,
  Share2,
  Shield,
  Target,
  Palette,
  Sparkles,
  ChevronDown,
  ChevronUp,
} from "lucide-react";


// Inlined theme CSS (previously in theme.js) to make this file self-contained
const THEME_CSS = `:root {
  --brand-gold: #ca8a04;
  --brand-gold-600: #B27000;
  --brand-gold-700: #8F5900;
  --brand-gold-soft: rgba(203,138,0,0.12);
  --brand-gold-light: rgba(203,138,0,0.4);
  --deep-navy: #06183A;
  --text: #0F172A;
  --muted: #6B7280;
  --muted-2: #9CA3AF;
  --color-accent: var(--brand-gold-600);
  --color-gold: var(--brand-gold);
  --surface: #ffffff;
  --bg: #f8fafc;
}
`;

// Additional page-specific CSS bundled as a string so the module stays valid JavaScript
const EXTRA_CSS = `
.choose-creator-list .creator-row:hover { background: #f8fafc; }

/* Avatar thumbnails for creators (small circular) */
.creator-avatar { width:32px; height:32px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; color: white; background: linear-gradient(135deg, #06b6d4, #3b82f6); flex-shrink:0; }
.creator-initials { user-select:none; }

/* Pulse / soft-glow animation for selection (does not change layout) */
@keyframes pulse-glow {
    0% { box-shadow: 0 0 0 0 rgba(203,138,0,0); transform: translateY(0); }
    /* stronger, but still subtle gold pulse with a small lift (non-layout) */
    50% { box-shadow: 0 10px 28px 8px rgba(var(--color-gold-rgb, 203,138,0),0.10); transform: translateY(-2px); }
    100% { box-shadow: 0 0 0 0 rgba(203,138,0,0); transform: translateY(0); }
}
.pulse-anim { animation: pulse-glow 1100ms cubic-bezier(0.22,1,0.36,1); }

/* Selected creator row visuals (thin, smooth gold outline and subtle lift) */
.choose-creator-list .creator-row.selected {
    background: rgba(var(--color-gold-rgb, 203,138,0), 0.06); /* very light warm tint */
    border: 1px solid rgba(var(--color-gold-rgb, 203,138,0), 0.18); /* thin gold border */
    box-shadow: 0 8px 20px rgba(var(--color-gold-rgb, 203,138,0), 0.04); /* soft spread for premium touch */
    transition: box-shadow 260ms ease, background 180ms ease, border-color 180ms ease;
}

/* Tweak provider card selected state to be thinner and smoother */
.provider-card.selected {
    transform: translateY(-6px);
    box-shadow: 0 14px 34px rgba(6,24,58,0.10);
    border: 1.5px solid rgba(var(--color-gold-rgb, 203,138,0), 0.22);
}

/* Focused input inside provider chooser: subtle thin gold glow */
.provider-card input:focus, .creator-search-input:focus {
    outline: none;
    border-color: var(--brand-gold-600);
    box-shadow: 0 6px 18px rgba(var(--color-gold-rgb, 203,138,0), 0.06);
    transition: box-shadow 220ms ease, border-color 180ms ease;
}

/* Creator name display: more premium hierarchy */
.creator-display { font-weight: 600; font-size: 13px; color: var(--deep-navy); line-height: 1; }
.creator-handle { font-size: 12px; color: #6b7280; margin-top: 2px; }

/* Small card micro animation on select (no layout change) */
@keyframes card-subtle-pulse {
    0% { box-shadow: 0 12px 28px rgba(6,24,58,0.10); }
    50% { box-shadow: 0 18px 40px rgba(6,24,58,0.12); }
    100% { box-shadow: 0 12px 28px rgba(6,24,58,0.10); }
}
.provider-card.selected { animation: card-subtle-pulse 1000ms ease-out; }

/* Edge fade to hint that carousel is scrollable */
.provider-carousel-wrap { position: relative; }
.provider-carousel-wrap::before, .provider-carousel-wrap::after {
    content: '';
    position: absolute;
    top: 0; bottom: 0; width: 36px; pointer-events: none;
}
.provider-carousel-wrap::before { left: 0; background: linear-gradient(90deg, rgba(255,255,255,1), rgba(255,255,255,0)); }
.provider-carousel-wrap::after { right: 0; background: linear-gradient(270deg, rgba(255,255,255,1), rgba(255,255,255,0)); }

/* Expanded provider card (choose creator) */
.provider-card.expanded { min-height: 180px; }
/* Expanded body: fade + slight lift for a smooth premium feel */
.provider-card .expanded-body {
    max-height: 420px;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-6px);
    transition: max-height 260ms ease, opacity 220ms ease, transform 220ms cubic-bezier(0.22,1,0.36,1);
}
.provider-card.expanded .expanded-body {
    opacity: 1;
    transform: translateY(0);
}
.choose-creator-list { max-height: 160px; overflow-y: auto; margin-top: 8px; }
.creator-row { padding: 8px; }

/* Clear button inside input */
.input-clear {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: rgba(15,23,42,0.5);
    padding: 6px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 140ms ease, color 140ms ease;
}
.input-clear:hover { background: rgba(15,23,42,0.03); color: rgba(15,23,42,0.7); }

/* No-results premium styling */
.no-results { color: var(--muted); will-change: opacity, transform; animation: fade-scale 320ms cubic-bezier(0.22,1,0.36,1) both; }
.no-results-illustration svg { width: 72px; height: 72px; display: block; }
.no-results-title { color: var(--deep-navy); }
.no-results-sub { color: #9CA3AF; }

/* Fade + gentle scale entrance for premium feel */
@keyframes fade-scale {
    0% { opacity: 0; transform: scale(0.98) translateY(-6px); }
    60% { opacity: 1; transform: scale(1.01) translateY(0); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

/* Input prefix styling for premium look */
.input-prefix {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--brand-gold-700);
    font-weight: 700;
    pointer-events: none;
    font-size: 13px;
}

.creator-search-input {
    background: rgba(255,255,255,1);
    border-radius: 10px;
    border: 1px solid rgba(15,23,42,0.06);
    padding-top: 9px;
    padding-bottom: 9px;
    font-size: 14px;
    color: var(--deep-navy);
    transition: box-shadow 200ms ease, border-color 160ms ease;
}
.creator-search-input::placeholder { color: rgba(15,23,42,0.28); font-weight: 500; }
.creator-search-input:focus { box-shadow: 0 10px 30px rgba(203,138,0,0.06); border-color: var(--brand-gold-600); }

/* Preset most-popular badge */
.most-popular-badge {
    position: absolute;
    top: -8px;
    right: -8px; /* push outside the button so it doesn't overlap the amount */
    background: var(--brand-gold-600);
    color: var(--on-gold);
    font-weight: 700;
    font-size: 9px; /* smaller */
    padding: 3px 6px; /* smaller */
    border-radius: 9999px;
    box-shadow: 0 6px 16px rgba(203,138,0,0.06);
    z-index: 3;
}

/* Refund modal styles removed (UI simplified) */

/* Preset button helpers for spacing and premium feel */
.preset-btn { min-width: 88px; display: inline-flex; align-items: center; justify-content: center; padding-left: 18px; padding-right: 18px; border-radius: 14px; }

/* Creator selected pill */
.creator-selected-pill {
    display: inline-block;
    padding: 4px 8px;
    background: rgba(15,23,42,0.04);
    border-radius: 9999px;
    font-size: 12px;
    color: var(--deep-navy);
    font-weight: 600;
}

/* --- Preview Card Responsive Fixes ---
   Keeps footer icons (bookmark/lightbulb) within the card on small screens
*/
.preview-card { overflow: visible; }

@media (max-width: 640px) {
    /* Reduce right padding so icons sit inside rounded edge */
    .preview-card { padding-right: 20px !important; }

    /* Nudge footer icons slightly toward the card edge so they visually sit on the rounded boundary */
    .preview-footer-icons { margin-right: -8px; }

    /* Inline (step-6) preview needs a stronger nudge than modal so there's more distance from the boosts icon */
    .inline-preview-footer-icons { margin-right: -51px; }

    /* Make footer icon buttons slightly smaller so they don't overflow */
    .preview-footer-icons > div {
        padding: 6px !important;
        min-width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-footer-icons svg {
        width: 16px !important;
        height: 16px !important;
    }

    /* Slightly stronger nudge on very small phones */
    @media (max-width: 420px) {
        .preview-footer-icons { margin-right: -10px; }
        .inline-preview-footer-icons { margin-right: -59px; }
        .claim-button { right: 6px !important; }
    }
  const handleEdit = (field) => {
    // Try to focus a matching input on the page, otherwise fall back to onEdit
    try {
      if (field === "description") {
        const el = document.getElementById("description-input");
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
          el.focus();
          el.classList.add("jump-highlight");
          setTimeout(() => el.classList.remove("jump-highlight"), 900);
          return;
        }
      }
      if (field === "title") {
        const el = document.getElementById("title-input");
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
          el.focus();
          el.classList.add("jump-highlight");
          setTimeout(() => el.classList.remove("jump-highlight"), 900);
          return;
        }
      }
      if (field === "budget") {
        // enable inline price editing when available
        if (setEditingPrice) {
          setPriceInput((displayPrice || 0).toFixed(2));
          setEditingPrice(true);
          // focus price input next tick
          setTimeout(() => {
            if (priceInputRef && priceInputRef.current) priceInputRef.current.focus();
          }, 50);
          return;
        }
      }
    } catch (err) {
      // ignore
    }
    if (onEdit) onEdit(field);
  };

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="text-center space-y-2">
        <h2 className="text-lg font-semibold text-gray-800">Review Your Request</h2>
        <p className="text-sm text-gray-500">Quickly review and edit any field inline.</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* Left: Big preview */}
        <div className="md:col-span-2 bg-[var(--surface)] border border-gray-100 rounded-xl shadow-sm p-5">
          <div className="flex items-start justify-between">
            <div>
              <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wide">Title</h3>
              <p className="text-lg font-semibold text-gray-900 mt-1">{title}</p>
            </div>
            <button onClick={() => handleEdit('title')} className="p-2 rounded-md hover:bg-gray-50 text-gray-500">
              <Pencil className="w-4 h-4" />
            </button>
          </div>

          <div className="mt-4">
            <div className="flex items-center justify-between">
              <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wide">Description</h3>
              <button onClick={() => handleEdit('description')} className="p-2 rounded-md hover:bg-gray-50 text-gray-500">
                <Pencil className="w-4 h-4" />
              </button>
            </div>
            <div className="mt-2 text-gray-700" style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word', maxHeight: '12rem', overflow: 'auto' }}>
              {description || <span className="text-gray-400">No description provided</span>}
            </div>
          </div>

          <div className="mt-6 flex flex-wrap gap-3">
            <span className="px-3 py-1 rounded-full bg-[var(--color-gold-cream)] text-[var(--color-gold)] text-xs font-medium">{selectedDeliveryType || 'Format'}</span>
            {selectedTones && selectedTones.map(t => (
              <span key={t} className="px-2 py-1 rounded-full bg-[var(--surface)] border border-gray-100 text-xs text-gray-700">{t}</span>
            ))}
          </div>
        </div>

        {/* Right: compact details */}
        <div className="bg-[var(--surface)] border border-gray-100 rounded-xl shadow-sm p-4 space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-xs text-gray-500 uppercase">Length</div>
              <div className="font-medium text-gray-900">{getLengthLabel()}</div>
            </div>
            <button onClick={() => handleEdit('length')} className="p-2 rounded-md hover:bg-gray-50 text-gray-500"><Pencil className="w-4 h-4" /></button>
          </div>

          <div className="flex items-center justify-between">
            <div>
              <div className="text-xs text-gray-500 uppercase">Privacy</div>
              <div className="font-medium text-gray-900">{getPrivacyLabel()}</div>
            </div>
            <button onClick={() => handleEdit('privacy')} className="p-2 rounded-md hover:bg-gray-50 text-gray-500"><Pencil className="w-4 h-4" /></button>
          </div>

          <div>
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs text-gray-500 uppercase">Budget</div>
                <div className="font-medium text-gray-900">{!editingPrice ? ('$' + ((displayPrice||0).toFixed(2))) : null}</div>
              </div>
              <div className="flex items-center">
                {editingPrice ? (
                  <div className="flex items-center">
                    <span className="text-gray-700 mr-2 font-semibold">$</span>
                    <input
                      type="text"
                      inputMode="decimal"
                      value={priceInput}
                      onChange={(e) => setPriceInput(sanitizePriceInput(e.target.value))}
                      onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); savePrice(); } }}
                      onBlur={() => savePrice()}
                      ref={priceInputRef}
                      className="p-2 rounded-lg border border-gray-200 text-sm w-28"
                    />
                  </div>
                ) : (
                  <button onClick={() => handleEdit('budget')} className="text-sm font-medium text-gray-900 bg-[var(--surface)] border border-gray-100 rounded px-3 py-2">Edit</button>
                )}
              </div>
            </div>
          </div>

          { (uploadedFiles?.length > 0 || referenceLinks?.length > 0) && (
            <div>
              <div className="text-xs text-gray-500 uppercase mb-2">References</div>
              <div className="text-sm text-gray-700 space-y-1">
                {uploadedFiles?.map((f,i)=>(<div key={i} className="truncate">{f.name}</div>))}
                {referenceLinks?.map((l,i)=>(<div key={i} className="text-blue-600 truncate">{l}</div>))}
              </div>
              <div className="mt-2 text-right">
                <button onClick={() => handleEdit('references')} className="text-sm text-[var(--color-accent)] font-medium">Edit references</button>
              </div>
            </div>
          )}
        </div>
      </div>

      <div className="flex justify-center">
        <button onClick={onEdit} className="text-sm text-[var(--color-accent)] underline">Open full editor</button>
      </div>
    </div>
  );
        
        

// --- Reusable Component for One-Time Video Details ---
const OneTimeVideoDetails = ({
  description,
  setDescription,
  title,
  setTitle,
  MAX_CHARS,
  showAdvanced,
}) => (
  <div className="space-y-8">
    {/* Confirmation Text */}
    <div className="flex items-center text-sm font-normal text-[var(--color-accent)]">
      <Check className="w-4 h-4 mr-2 text-[var(--color-accent)]" />
      <span className="tracking-tight">Format selected! Now add details.</span>
    </div>

    {/* Examples removed per user request */}

    <div className="flex items-center justify-between text-sm text-gray-600">
          <span className="italic">Using the Description and Title you entered above for this one-time video.</span>
      <button
        type="button"
        className="ml-4 text-sm font-medium text-[var(--color-accent)] hover:underline"
        onClick={() => {
          const el = document.getElementById("description-input");
          if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "center" });
            el.focus();
            el.classList.add("jump-highlight");
            setTimeout(() => el.classList.remove("jump-highlight"), 900);
          }
          const titleEl = document.getElementById("title-input");
          if (titleEl) {
            // focus title after a slight delay so the description is focused first
            setTimeout(() => {
              titleEl.focus();
              titleEl.classList.add("jump-highlight");
              setTimeout(() => titleEl.classList.remove("jump-highlight"), 900);
            }, 300);
          }
        }}
      >
        Edit
      </button>
    </div>
  </div>
);

// --- Component for Recurrent Video Details (Multi-Step Flow) ---
const RecurrentVideoDetails = ({
  description,
  setDescription,
  title,
  setTitle,
  MAX_CHARS,
  MIN_CHARS,
  recurrentStep,
  selectedFrequency,
  setSelectedFrequency,
  selectedTones,
  setSelectedTones,
  customRecurrentDates,
  setCustomRecurrentDates,
}) => {
  // Frequency options based on user images
  const frequencyOptions = [
    {
      type: "daily",
      title: "Daily",
      subtitle: "New videos delivered every day",
      Icon: Clock,
    },
    {
      type: "weekly",
      title: "Weekly",
      subtitle: "New videos delivered every week",
      Icon: Repeat,
    },
    {
      type: "monthly",
      title: "Monthly",
      subtitle: "New videos delivered every month",
      Icon: Calendar,
    },
    {
      type: "custom",
      title: "Custom",
      subtitle: "Set a custom delivery schedule",
      Icon: Calendar,
    },
  ];

  if (recurrentStep === 1) {
    return (
      <div className="space-y-8">
        <div className="flex items-center text-sm font-normal text-[var(--color-accent)]">
          <Check className="w-4 h-4 mr-2 text-[var(--color-accent)]" />
          <span className="tracking-tight">Frequency selection unlocked!</span>
        </div>

        <div className="flex items-center justify-between text-sm text-gray-600">
          <span className="italic">Using the Description and Title you entered above for this recurring request.</span>
          <button
            type="button"
            className="ml-4 text-sm font-medium text-[var(--color-accent)] hover:underline"
            onClick={() => {
              const el = document.getElementById("description-input");
              if (el) {
                el.scrollIntoView({ behavior: "smooth", block: "center" });
                el.focus();
                el.classList.add("jump-highlight");
                setTimeout(() => el.classList.remove("jump-highlight"), 900);
              }
            }}
          >
            Edit
          </button>
        </div>

        <div className="space-y-2">
          <h2 className="text-lg font-semibold text-gray-800">
            How often would you like creators to deliver new videos?
          </h2>
          <p className="text-sm text-gray-500">
            Creators will plan their uploads according to your chosen rhythm.
          </p>
        </div>

        {/* Recurrent examples removed per user request */}

        <div className="space-y-4">
          <FrequencyDropdown
            options={frequencyOptions}
            selected={selectedFrequency}
            setSelected={setSelectedFrequency}
          />

          {selectedFrequency === "custom" && (
            <div className="mt-3">
              <SeriesCalendar
                selectedDates={customRecurrentDates}
                setSelectedDates={setCustomRecurrentDates}
              />
            </div>
          )}
        </div>
      </div>
    );
  }

  if (recurrentStep === 3)
    return (
            <ToneStyleStep
              selectedTones={selectedTones}
              setSelectedTones={setSelectedTones}
              selectedStyles={selectedStyles}
              setSelectedStyles={setSelectedStyles}
            />
    );
  if (recurrentStep === 4) return <VideoLengthStep />;
  if (recurrentStep === 5) return <ReferencesStep />;
  if (recurrentStep === 6)
    return (
      <PrivacySettingsStep
        selectedPrivacy={selectedPrivacy}
        setSelectedPrivacy={setSelectedPrivacy}
      />
    );
  if (recurrentStep === 8) return <SponsorConfirmation />;
  return null;
};

// --- Reusable Component for Tone & Style Selection (Dropdown) ---
const ToneStyleStep = ({ selectedTones, setSelectedTones, selectedStyles, setSelectedStyles }) => {
  const [open, setOpen] = useState(false);
  const [openStyle, setOpenStyle] = useState(false);
  const buttonRef = useRef(null);
  const listRef = useRef(null);
  const listRefStyle = useRef(null);
  const openTimerRef = useRef(null);
  const focusTimerRef = useRef(null);
  const containerRef = useRef(null);

  const basicTones = [
    { id: "professional", label: "Professional", Icon: Briefcase },
    { id: "casual", label: "Casual", Icon: Coffee },
    { id: "inspirational", label: "Inspirational / Motivational", Icon: TrendingUp },
    { id: "humorous", label: "Humorous / Lighthearted", Icon: Smile },
    { id: "emotional", label: "Emotional / Heartfelt", Icon: Heart },
    { id: "analytical", label: "Analytical / Educational", Icon: BookOpen },
  ];

  const advancedTones = [
    { id: "dramatic", label: "Dramatic / Cinematic", Icon: Film },
    { id: "sarcastic", label: "Sarcastic / Satirical", Icon: MessageCircle },
    { id: "romantic", label: "Romantic / Soothing", Icon: User },
    { id: "bold", label: "Bold / Controversial", Icon: Shield },
    { id: "serious", label: "Serious / Neutral", Icon: Target },
    { id: "experimental", label: "Experimental / Artistic", Icon: Palette },
    { id: "hopeful", label: "Hopeful / Reflective", Icon: Sparkles },
  ];

  const toggleTone = (id) => {
    if (selectedTones.includes(id)) {
      setSelectedTones(selectedTones.filter((t) => t !== id));
    } else {
      if (selectedTones.length < 2) {
        setSelectedTones([...selectedTones, id]);
        // Close the dropdown after a selection to reduce friction
        setOpen(false);
      }
    }
  };

  // Styles (separate picker)
  const basicStyles = [
    { id: "cinematic", label: "Cinematic", Icon: Film },
    { id: "minimal", label: "Minimal", Icon: Palette },
    { id: "documentary", label: "Documentary", Icon: BookOpen },
    { id: "animated", label: "Animated", Icon: Sparkles },
    { id: "vibrant", label: "Vibrant", Icon: TrendingUp },
    { id: "intimate", label: "Intimate", Icon: Heart },
  ];

  const toggleStyle = (id) => {
    if (selectedStyles.includes(id)) {
      setSelectedStyles(selectedStyles.filter((s) => s !== id));
    } else {
      // Limit styles to a single choice for clarity
      setSelectedStyles([id]);
      setOpenStyle(false);
    }
  };

  // Tone dropdown no longer auto-opens; users open it deliberately.

  useEffect(() => {
    // Close dropdown when user taps/clicks outside, or presses Escape.
    const handleOutside = (e) => {
      try {
        if (!open) return;
        const el = containerRef.current;
        if (!el) return;
        if (!el.contains(e.target)) {
          setOpen(false);
        }
      } catch (err) {}
    };

    const handleKey = (e) => {
      if (e.key === "Escape" && open) setOpen(false);
    };

    document.addEventListener("mousedown", handleOutside);
    document.addEventListener("touchstart", handleOutside, { passive: true });
    document.addEventListener("keydown", handleKey);
    return () => {
      document.removeEventListener("mousedown", handleOutside);
      document.removeEventListener("touchstart", handleOutside);
      document.removeEventListener("keydown", handleKey);
    };
  }, [open]);

  const renderToneLabel = () => {
    if (selectedTones.length === 0) return <div className="text-sm text-gray-500">Choose tone</div>;
    return (
      <div className="flex items-center space-x-2">
        {selectedTones.map((id) => {
          const opt = [...basicTones, ...advancedTones].find((o) => o.id === id);
          if (!opt) return null;
          return (
            <span key={id} className="inline-flex items-center px-2 py-1 rounded-full bg-[var(--color-gold-cream)] text-[var(--color-gold)] text-xs font-medium">
              <opt.Icon className="w-3 h-3 mr-1" />{opt.label.split(' ')[0]}
            </span>
          );
        })}
      </div>
    );
  };

  const renderStyleLabel = () => {
    if (!selectedStyles || selectedStyles.length === 0) return <div className="text-sm text-gray-500">Choose style</div>;
    const id = selectedStyles[0];
    const opt = basicStyles.find((o) => o.id === id);
    if (!opt) return <div className="text-sm text-gray-500">Choose style</div>;
    return (
      <div className="flex items-center space-x-2">
        <span className="inline-flex items-center px-2 py-1 rounded-full bg-[var(--color-gold-cream)] text-[var(--color-gold)] text-xs font-medium">
          <opt.Icon className="w-3 h-3 mr-1" />{opt.label.split(' ')[0]}
        </span>
      </div>
    );
  };

  return (
    <div ref={containerRef} className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500 relative">
      <div className="space-y-2 text-left flex items-center">
        <Crown className="w-5 h-5 mr-3 text-[var(--color-gold)] flex-shrink-0" style={{ transform: 'translateY(4px)' }} />
        <h3 className="text-gray-800 font-semibold text-base block tracking-tight">
          Choose Your Tone & Style <span className="text-xs text-gray-500 font-normal ml-2">(Select up to 2 tones that best fit your video)</span>
        </h3>
      </div>

      <div className="flex flex-col gap-3">
        {/* Tone picker */}
        <div className="relative">
          <button
            type="button"
            onClick={() => setOpen((s) => !s)}
            aria-haspopup="listbox"
            aria-expanded={open}
            className="w-full flex items-center justify-between p-4 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm"
          >
            <div className="flex items-center">
              {renderToneLabel()}
            </div>
            <ChevronDown className="w-4 h-4 text-gray-500" />
          </button>

          {open && (
            <div className="absolute z-30 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg">
              <ul ref={listRef} role="listbox" aria-label="Tone" className="divide-y divide-gray-100 max-h-72 overflow-auto">
                {[...basicTones, ...advancedTones].map((tone) => {
                  const disabled = !selectedTones.includes(tone.id) && selectedTones.length >= 2;
                  return (
                    <li
                      key={tone.id}
                      role="option"
                      aria-selected={selectedTones.includes(tone.id)}
                      tabIndex={disabled ? -1 : 0}
                      onClick={() => !disabled && toggleTone(tone.id)}
                      onKeyDown={(e) => {
                        if (!disabled && (e.key === 'Enter' || e.key === ' ')) {
                          e.preventDefault();
                          toggleTone(tone.id);
                        }
                      }}
                      className={"flex items-center p-3 hover:bg-gray-50 cursor-pointer " + (disabled ? 'opacity-50 cursor-not-allowed' : '')}
                    >
                      <tone.Icon className={"w-5 h-5 mr-3 " + (selectedTones.includes(tone.id) ? 'text-[var(--color-gold)]' : 'text-gray-400')} />
                      <div className="flex-1">
                        <div className="text-sm font-medium text-gray-800">{tone.label}</div>
                      </div>
                      {selectedTones.includes(tone.id) && <Check className="w-4 h-4 text-[var(--color-gold)]" />}
                    </li>
                  );
                })}
              </ul>
              <div className="p-3 text-xs text-gray-500 border-t border-gray-100">Tip: choose up to two tones. Selected tones help creators match style.</div>
            </div>
          )}
        </div>

        {/* Style picker */}
        <div className="relative">
          <button
            type="button"
            onClick={() => setOpenStyle((s) => !s)}
            aria-haspopup="listbox"
            aria-expanded={openStyle}
            className="w-full flex items-center justify-between p-4 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm"
          >
            <div className="flex items-center">
              {renderStyleLabel()}
            </div>
            <ChevronDown className="w-4 h-4 text-gray-500" />
          </button>

          {openStyle && (
            <div className="absolute z-30 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg">
              <ul ref={listRefStyle} role="listbox" aria-label="Style" className="divide-y divide-gray-100 max-h-72 overflow-auto">
                {basicStyles.map((style) => {
                  const selected = selectedStyles.includes(style.id);
                  return (
                    <li
                      key={style.id}
                      role="option"
                      aria-selected={selected}
                      tabIndex={0}
                      onClick={() => toggleStyle(style.id)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                          e.preventDefault();
                          toggleStyle(style.id);
                        }
                      }}
                      className={`flex items-center p-3 hover:bg-gray-50 cursor-pointer ${selected ? '' : ''}`}
                    >
                      <style.Icon className={`w-5 h-5 mr-3 ${selected ? 'text-[var(--color-gold)]' : 'text-gray-400'}`} />
                      <div className="flex-1">
                        <div className="text-sm font-medium text-gray-800">{style.label}</div>
                      </div>
                      {selected && <Check className="w-4 h-4 text-[var(--color-gold)]" />}
                    </li>
                  );
                })}
              </ul>
              <div className="p-3 text-xs text-gray-500 border-t border-gray-100">Tip: choose a style to help communicate visual approach.</div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- Reusable Component for Video Length Selection (New Step) ---
const VideoLengthStep = ({
  selectedLength,
  setSelectedLength,
  customLength,
  setCustomLength,
}) => {
  const lengths = [
    {
      id: "short-form",
      label: "Short Form",
      duration: "15 sec – 1 min",
      description:
        "Quick insights, reactions, jokes, highlights – TikTok/Reel style",
    },
    {
      id: "standard",
      label: "Standard",
      duration: "2–5 min",
      description:
        "Mini explanations, challenges, creative short stories, tutorials",
    },
    {
      id: "extended",
      label: "Extended",
      duration: "6–15 min",
      description: "Deeper dives, analyses, vlogs, storytime, discussions",
    },
    {
      id: "long-form",
      label: "Long Form",
      duration: "16–30+ min",
      description: "Documentaries, interviews, or in-depth guides",
    },
    {
      id: "custom",
      label: "Custom",
      duration: "User defined",
      description: "Let creators decide what fits best",
    },
  ];

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      {/* Header: use the question as the primary left-aligned heading (matches Tone & Style) */}
      <div className="space-y-2 text-left flex items-center">
        <Crown className="w-5 h-5 mr-3 text-[var(--color-gold)] flex-shrink-0" style={{ transform: 'translateY(4px)' }} />
        <h3 className="text-gray-800 font-semibold text-base block tracking-tight">
          How long should your video be?
        </h3>
      </div>

      {/* Examples Box */}
      <div className="rounded-xl cream-glow-box p-5" style={{ background: "radial-gradient(circle at 16% 16%, rgba(var(--color-gold-rgb,203,138,0),0.08), rgba(var(--color-gold-rgb,203,138,0),0.02) 26%, var(--color-cream-bg) 60%), var(--color-cream-bg)", border: "1px solid rgba(var(--color-gold-rgb,203,138,0),0.10)", boxShadow: "inset 0 4px 12px rgba(var(--color-gold-rgb,203,138,0),0.02)" }}>
        <div className="flex items-center mb-3">
          <Lightbulb className="w-5 h-5 text-[var(--color-gold)] mr-2" />
          <h3 className="text-sm font-normal text-gray-700">
            Examples for video length:
          </h3>
        </div>
        <ul className="space-y-2 text-xs text-gray-600 list-none pl-0">
          <li>
            <strong className="text-gray-800">Short Form (15s–1m):</strong>{" "}
            Quick tips, reactions, TikTok/Reel-style content
          </li>
          <li>
            <strong className="text-gray-800">Standard (2–5m):</strong>{" "}
            Tutorials, challenges, product reviews, how-tos
          </li>
          <li>
            <strong className="text-gray-800">Extended (6–15m):</strong> Deep
            dives, vlogs, detailed explanations, discussions
          </li>
          <li>
            <strong className="text-gray-800">Long Form (16–30+m):</strong>{" "}
            Documentaries, interviews, masterclasses, podcasts
          </li>
          <li>
            <strong className="text-gray-800">Custom:</strong> Let creators
            choose based on your content needs
          </li>
        </ul>
      </div>

      {/* Lengths Dropdown (compact) */}
      <VideoLengthDropdown
        lengths={lengths}
        selectedLength={selectedLength}
        setSelectedLength={setSelectedLength}
        customLength={customLength}
        setCustomLength={setCustomLength}
      />
    </div>
  );
};

// --- Compact Dropdown for Video Lengths (extract for clarity) ---
const VideoLengthDropdown = ({ lengths, selectedLength, setSelectedLength, customLength, setCustomLength }) => {
  const [open, setOpen] = useState(false);
  const listRef = useRef(null);
  const btnRef = useRef(null);

  useEffect(() => {
    const onDoc = (e) => {
      if (!open) return;
      if (listRef.current && listRef.current.contains(e.target)) return;
      if (btnRef.current && btnRef.current.contains(e.target)) return;
      setOpen(false);
    };
    document.addEventListener("mousedown", onDoc);
    document.addEventListener("touchstart", onDoc);
    return () => {
      document.removeEventListener("mousedown", onDoc);
      document.removeEventListener("touchstart", onDoc);
    };
  }, [open]);

  const handleSelect = (id) => {
    setSelectedLength(id);
    setOpen(false);
  };

  const selectedObj = lengths.find((l) => l.id === selectedLength);

  return (
    <div className="relative">
      <button
        ref={btnRef}
        type="button"
        aria-haspopup="listbox"
        aria-expanded={open}
        onClick={() => setOpen((s) => !s)}
        className="w-full flex items-center justify-between p-4 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm"
      >
        <div className="text-left">
          {selectedObj ? (
            <div className="text-sm font-medium text-gray-800">{selectedObj.label}</div>
          ) : (
            <div className="text-sm text-gray-500">Select preferred video length</div>
          )}
          <div className="text-xs text-gray-400">{selectedObj ? selectedObj.duration : ""}</div>
        </div>
        <ChevronDown className="w-4 h-4 text-gray-500" />
      </button>

      {open && (
        <div className="absolute z-20 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg">
          <ul ref={listRef} role="listbox" aria-label="Video lengths" className="divide-y divide-gray-100">
            {lengths.map((len) => (
              <li
                key={len.id}
                role="option"
                tabIndex={0}
                aria-selected={selectedLength === len.id}
                onClick={() => handleSelect(len.id)}
                onKeyDown={(e) => {
                  if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    handleSelect(len.id);
                  }
                }}
                className={`p-3 flex items-start cursor-pointer hover:bg-gray-50 ${selectedLength === len.id ? "bg-[var(--color-gold-cream)]" : ""}`}
              >
                <div className="flex-1">
                  <div className={`text-sm font-medium ${selectedLength === len.id ? "text-gray-900" : "text-gray-800"}`}>{len.label}</div>
                  <div className="text-xs text-gray-500">{len.duration}</div>
                  <div className="text-xs text-gray-600 mt-1">{len.description}</div>
                  {len.id === "custom" && selectedLength === "custom" && (
                    <div className="mt-3" onClick={(e) => e.stopPropagation()}>
                      <input
                        type="text"
                        placeholder="Enter desired length (e.g. 45 mins)"
                        value={customLength}
                        onChange={(e) => setCustomLength(e.target.value)}
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-soft)] focus:border-[var(--color-accent)] transition-all"
                        autoFocus
                      />
                    </div>
                  )}
                </div>
                {selectedLength === len.id && (
                  <Check className="w-4 h-4 text-[var(--color-gold)] ml-3" />
                )}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};

// --- Compact Dropdown for Frequency Selection ---
const FrequencyDropdown = ({ options, selected, setSelected }) => {
  const [open, setOpen] = useState(false);
  const listRef = useRef(null);
  const btnRef = useRef(null);

  useEffect(() => {
    const onDoc = (e) => {
      if (!open) return;
      if (listRef.current && listRef.current.contains(e.target)) return;
      if (btnRef.current && btnRef.current.contains(e.target)) return;
      setOpen(false);
    };
    document.addEventListener("mousedown", onDoc);
    document.addEventListener("touchstart", onDoc);
    return () => {
      document.removeEventListener("mousedown", onDoc);
      document.removeEventListener("touchstart", onDoc);
    };
  }, [open]);

  const handleSelect = (id) => {
    setSelected(id);
    setOpen(false);
  };

  const selectedObj = options.find((o) => o.type === selected);

  return (
    <div className="relative">
      <button
        ref={btnRef}
        type="button"
        aria-haspopup="listbox"
        aria-expanded={open}
        onClick={() => setOpen((s) => !s)}
        className="w-full flex items-center justify-between p-4 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm"
      >
        <div className="text-left">
          {selectedObj ? (
            <div className="text-sm font-medium text-gray-800">{selectedObj.title}</div>
          ) : (
            <div className="text-sm text-gray-500">Select frequency</div>
          )}
          <div className="text-xs text-gray-400">{selectedObj ? selectedObj.subtitle : ""}</div>
        </div>
        <ChevronDown className="w-4 h-4 text-gray-500" />
      </button>

      {open && (
        <div className="absolute z-20 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg">
          <ul ref={listRef} role="listbox" aria-label="Frequency options" className="divide-y divide-gray-100">
            {options.map((opt) => (
              <li
                key={opt.type}
                role="option"
                tabIndex={0}
                aria-selected={selected === opt.type}
                onClick={() => handleSelect(opt.type)}
                onKeyDown={(e) => {
                  if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    handleSelect(opt.type);
                  }
                }}
                className={`p-3 flex items-start cursor-pointer hover:bg-gray-50 ${selected === opt.type ? "bg-[var(--color-gold-cream)]" : ""}`}
              >
                <div className="flex-1">
                  <div className={`text-sm font-medium ${selected === opt.type ? "text-gray-900" : "text-gray-800"}`}>{opt.title}</div>
                  <div className="text-xs text-gray-500">{opt.subtitle}</div>
                </div>
                {selected === opt.type && <Check className="w-4 h-4 text-[var(--color-gold)] ml-3" />}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};

// --- Reusable Component for References (New Step) ---
const ReferencesStep = ({ files, setFiles, links, setLinks }) => {
  const fileInputRef = useRef(null);
  const [linkInput, setLinkInput] = useState("");

  const handleFileChange = (e) => {
    if (e.target.files && e.target.files.length > 0) {
      setFiles([...files, ...Array.from(e.target.files)]);
    }
  };

  const handleAddLink = () => {
    if (linkInput.trim()) {
      setLinks([...links, linkInput.trim()]);
      setLinkInput("");
    }
  };

  const removeFile = (index) => {
    setFiles(files.filter((_, i) => i !== index));
  };

  const removeLink = (index) => {
    setLinks(links.filter((_, i) => i !== index));
  };

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      {/* Upload Area */}
      <div
        onClick={() => fileInputRef.current.click()}
        className="border-2 border-dashed border-gray-200 rounded-xl p-8 flex flex-col items-center justify-center text-center hover:bg-[var(--bg)] transition-colors cursor-pointer bg-[var(--surface)]"
      >
        <input
          type="file"
          multiple
          className="hidden"
          ref={fileInputRef}
          onChange={handleFileChange}
        />
        <div className="p-3 bg-gray-100 rounded-full mb-3">
          <FileText className="w-6 h-6 text-gray-500" />
        </div>
        <h3 className="text-sm font-normal text-gray-700">
          Upload reference files
        </h3>
        <p className="text-xs text-gray-400 mt-1">
          Images, videos, PDFs, documents
        </p>
      </div>

      {/* File List */}
      {files.length > 0 && (
        <div className="space-y-2 animate-in fade-in slide-in-from-top-2">
          {files.map((file, index) => (
            <div
              key={index}
              className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100"
            >
              <div className="flex items-center overflow-hidden">
                <FileText className="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" />
                <span className="text-sm text-gray-700 truncate">
                  {file.name}
                </span>
              </div>
              <button
                onClick={() => removeFile(index)}
                className="text-gray-400 hover:text-red-500 ml-2"
              >
                <X className="w-4 h-4" />
              </button>
            </div>
          ))}
        </div>
      )}

      {/* Link Input */}
      <div className="flex items-center space-x-2">
        <input
          type="text"
          placeholder="Add reference links..."
          value={linkInput}
          onChange={(e) => setLinkInput(e.target.value)}
          onKeyDown={(e) => e.key === "Enter" && handleAddLink()}
          className="flex-1 p-4 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-soft)] focus:border-[var(--color-accent)] transition-all"
        />
        <button
          onClick={handleAddLink}
          className="p-4 bg-gray-100 rounded-xl text-gray-500 hover:bg-gray-200 transition-colors"
        >
          <LinkIcon className="w-5 h-5" />
        </button>
      </div>

      {/* Link List */}
      {links.length > 0 && (
        <div className="space-y-2 animate-in fade-in slide-in-from-top-2">
          {links.map((link, index) => (
            <div
              key={index}
              className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100"
            >
              <div className="flex items-center overflow-hidden">
                <LinkIcon className="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" />
                <span className="text-sm text-blue-600 truncate underline">
                  {link}
                </span>
              </div>
              <button
                onClick={() => removeLink(index)}
                className="text-gray-400 hover:text-red-500 ml-2"
              >
                <X className="w-4 h-4" />
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// --- Reusable Component for Calendar (New) ---
const SeriesCalendar = ({ selectedDates, setSelectedDates }) => {
  const [currentDate, setCurrentDate] = useState(new Date());

  const getDaysInMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  };

  const getFirstDayOfMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
  };

  const handleDateClick = (day) => {
    const dateStr = new Date(
      currentDate.getFullYear(),
      currentDate.getMonth(),
      day
    ).toDateString();
    if (selectedDates.includes(dateStr)) {
      setSelectedDates(selectedDates.filter((d) => d !== dateStr));
    } else {
      setSelectedDates([...selectedDates, dateStr]);
    }
  };

  const daysInMonth = getDaysInMonth(currentDate);
  const firstDay = getFirstDayOfMonth(currentDate);
  const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
  const blanks = Array.from({ length: firstDay }, (_, i) => i);

  const monthNames = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];

  return (
    <div className="mt-4 p-4 bg-[var(--surface)] rounded-xl border border-gray-200 shadow-sm animate-in fade-in slide-in-from-top-2">
      <div className="flex justify-between items-center mb-4">
        <button
          onClick={() =>
            setCurrentDate(
              new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1)
            )
          }
          className="p-1 hover:bg-[var(--bg)] rounded-full"
        >
          <ChevronLeft className="w-5 h-5 text-gray-600" />
        </button>
        <span className="font-semibold text-gray-800">
          {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
        </span>
        <button
          onClick={() =>
            setCurrentDate(
              new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)
            )
          }
          className="p-1 hover:bg-[var(--bg)] rounded-full"
        >
          <ChevronRight className="w-5 h-5 text-gray-600" />
        </button>
      </div>
      <div className="grid grid-cols-7 gap-1 text-center mb-2">
        {["S", "M", "T", "W", "T", "F", "S"].map((d, i) => (
          <div key={i} className="text-xs font-medium text-gray-400">
            {d}
          </div>
        ))}
      </div>
      <div className="grid grid-cols-7 gap-1">
        {blanks.map((b) => (
          <div key={`blank-${b}`} />
        ))}
        {days.map((day) => {
          const dateStr = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth(),
            day
          ).toDateString();
          const isSelected = selectedDates.includes(dateStr);
          return (
            <div
              key={day}
              onClick={(e) => {
                e.stopPropagation();
                handleDateClick(day);
              }}
              className={`
                                h-8 w-8 flex items-center justify-center rounded-full text-sm cursor-pointer transition-colors
                                ${
                                  isSelected
                                    ? "bg-[var(--color-gold)] text-white"
                                    : "hover:bg-[var(--bg)] text-gray-700"
                                }
                            `}
            >
              {day}
            </div>
          );
        })}
      </div>
      <div className="mt-3 text-xs text-gray-500 text-center">
        {selectedDates.length} dates selected
      </div>
    </div>
  );
};

// --- Component for Series Video Details ---
const SeriesVideoDetails = ({
  description,
  setDescription,
  title,
  setTitle,
  MAX_CHARS,
  seriesStep,
  numberOfEpisodes,
  setNumberOfEpisodes,
  selectedReleaseSchedule,
  setSelectedReleaseSchedule,
  customSeriesDates,
  setCustomSeriesDates,
}) => {
  const scheduleOptions = [
    { id: "all-at-once", label: "All at once", icon: Film },
    { id: "weekly", label: "Weekly", icon: Clock },
    { id: "monthly", label: "Monthly", icon: Calendar },
    { id: "custom", label: "Custom Dates", icon: Pencil },
  ];

  // Local state for a compact, editable episodes dropdown
  const [episodesOpen, setEpisodesOpen] = useState(false);
  const episodesRef = useRef(null);
  const episodesBtnRef = useRef(null);

  useEffect(() => {
    const onDoc = (e) => {
      if (!episodesOpen) return;
      if (episodesRef.current && episodesRef.current.contains(e.target)) return;
      if (episodesBtnRef.current && episodesBtnRef.current.contains(e.target)) return;
      setEpisodesOpen(false);
    };
    document.addEventListener("mousedown", onDoc);
    document.addEventListener("touchstart", onDoc);
    return () => {
      document.removeEventListener("mousedown", onDoc);
      document.removeEventListener("touchstart", onDoc);
    };
  }, [episodesOpen]);

  if (seriesStep === 1) {
    return (
      <div className="space-y-4">
        <div className="flex items-center justify-between text-sm text-gray-600">
          <span className="italic">Using the Description and Title you entered above for this series.</span>
          <button
            type="button"
            className="ml-4 text-sm font-medium text-[var(--color-accent)] hover:underline"
            onClick={() => {
              const el = document.getElementById("description-input");
              if (el) {
                el.scrollIntoView({ behavior: "smooth", block: "center" });
                el.focus();
                el.classList.add("jump-highlight");
                setTimeout(() => el.classList.remove("jump-highlight"), 900);
              }
            }}
          >
            Edit
          </button>
        </div>
      </div>
    );
  }

  if (seriesStep === 2) {
    return (
      <div className="space-y-8">
        <div className="flex items-center text-sm font-normal text-[var(--color-accent)]">
          <Check className="w-4 h-4 mr-2 text-[var(--color-accent)]" />
          <span className="tracking-tight">Format selected! Now detail your series.</span>
        </div>

        <div className="flex items-center justify-between text-sm text-gray-600">
          <span className="italic">Using the Description and Title you entered above for this series.</span>
          <button
            type="button"
            className="ml-4 text-sm font-medium text-[var(--color-accent)] hover:underline"
            onClick={() => {
              const el = document.getElementById("description-input");
              if (el) {
                el.scrollIntoView({ behavior: "smooth", block: "center" });
                el.focus();
                el.classList.add("jump-highlight");
                setTimeout(() => el.classList.remove("jump-highlight"), 900);
              }
              const titleEl = document.getElementById("title-input");
              if (titleEl) {
                setTimeout(() => {
                  titleEl.focus();
                  titleEl.classList.add("jump-highlight");
                  setTimeout(() => titleEl.classList.remove("jump-highlight"), 900);
                }, 300);
              }
            }}
          >
            Edit
          </button>
        </div>

        <div>
          <label className="text-gray-800 font-semibold text-base block mb-3">
            How many episodes would you like?
          </label>

          <div className="relative" style={{ maxWidth: 220 }}>
            <button
              ref={episodesBtnRef}
              type="button"
              onClick={() => setEpisodesOpen((s) => !s)}
              className="w-full flex items-center justify-between px-3 py-2 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm"
            >
              <div className="flex items-center space-x-3">
                <ChevronDown className="w-4 h-4 text-gray-500" />
                <div className="text-lg font-semibold">{numberOfEpisodes}</div>
                <span className="text-xs text-gray-400">episodes</span>
              </div>
              <ChevronUp className="w-4 h-4 text-gray-500" />
            </button>

            {episodesOpen && (
              <div
                ref={episodesRef}
                className="absolute z-30 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg p-3"
              >
                <div className="flex items-center justify-between mb-3">
                  <button
                    onClick={() => setNumberOfEpisodes(Math.max(1, numberOfEpisodes - 1))}
                    className="p-2 rounded-lg bg-gray-50 hover:bg-gray-100"
                    aria-label="Decrease episodes"
                  >
                    <ChevronDown className="w-4 h-4" />
                  </button>
                  <input
                    type="number"
                    value={numberOfEpisodes}
                    onChange={(e) => {
                      const v = Math.max(1, parseInt(e.target.value || "0", 10) || 1);
                      setNumberOfEpisodes(v);
                    }}
                    className="mx-3 text-center font-bold w-16 p-2 border rounded-lg"
                    aria-label="Number of episodes"
                  />
                  <button
                    onClick={() => setNumberOfEpisodes(numberOfEpisodes + 1)}
                    className="p-2 rounded-lg bg-gray-50 hover:bg-gray-100"
                    aria-label="Increase episodes"
                  >
                    <ChevronUp className="w-4 h-4" />
                  </button>
                </div>

                <div className="grid grid-cols-3 gap-2">
                  {[3, 5, 10, 25, 50, 100].map((n) => (
                    <button
                      key={n}
                      onClick={() => {
                        setNumberOfEpisodes(n);
                        setEpisodesOpen(false);
                      }}
                      className="py-2 px-2 rounded-lg bg-gray-50 hover:bg-gray-100 text-sm font-medium"
                    >
                      {n}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>

        <div>
          <label className="text-gray-800 font-semibold text-base block mb-3">
            How often would you like personalized videos delivered?
          </label>
          <p className="text-xs text-gray-500 mb-2">Pick a rhythm creators should follow (daily, weekly, monthly, or custom).</p>
          <div className="w-full">
            <FrequencyDropdown
              options={scheduleOptions.map((o) => ({ type: o.id, title: o.label, subtitle: o.label }))}
              selected={selectedReleaseSchedule}
              setSelected={setSelectedReleaseSchedule}
            />
          </div>
          {selectedReleaseSchedule === "custom" && (
            <SeriesCalendar
              selectedDates={customSeriesDates}
              setSelectedDates={setCustomSeriesDates}
            />
          )}
        </div>
      </div>
    );
  }
  return null;
};

// --- Compact editable dropdown for Catalogue target videos (mirrors episodes control)
const CatalogueTargetDropdown = ({ value, setValue }) => {
  const [open, setOpen] = useState(false);
  const targetRef = useRef(null);
  const targetBtnRef = useRef(null);

  useEffect(() => {
    const onDoc = (e) => {
      if (!open) return;
      if (targetRef.current && targetRef.current.contains(e.target)) return;
      if (targetBtnRef.current && targetBtnRef.current.contains(e.target)) return;
      setOpen(false);
    };
    document.addEventListener("mousedown", onDoc);
    document.addEventListener("touchstart", onDoc);
    return () => {
      document.removeEventListener("mousedown", onDoc);
      document.removeEventListener("touchstart", onDoc);
    };
  }, [open]);

  return (
    <div className="relative" style={{ maxWidth: 220 }}>
      <button
        ref={targetBtnRef}
        type="button"
        onClick={() => setOpen((s) => !s)}
        className="w-full flex items-center justify-between px-3 py-2 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm"
      >
        <div className="flex items-center space-x-3">
          <ChevronDown className="w-4 h-4 text-gray-500" />
          <div className="text-lg font-semibold">{value}</div>
          <span className="text-xs text-gray-400">videos</span>
        </div>
        <ChevronUp className="w-4 h-4 text-gray-500" />
      </button>

      {open && (
        <div ref={targetRef} className="absolute z-30 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg p-3">
          <div className="flex items-center justify-between mb-3">
            <button
              onClick={() => setValue(Math.max(1, (value || 0) - 1))}
              className="p-2 rounded-lg bg-gray-50 hover:bg-gray-100"
              aria-label="Decrease videos"
            >
              <ChevronDown className="w-4 h-4" />
            </button>
            <input
              type="number"
              value={value}
              onChange={(e) => {
                const v = Math.max(1, parseInt(e.target.value || "0", 10) || 1);
                setValue(v);
              }}
              className="mx-3 text-center font-bold w-16 p-2 border rounded-lg"
              aria-label="Number of videos"
            />
            <button
              onClick={() => setValue((value || 0) + 1)}
              className="p-2 rounded-lg bg-gray-50 hover:bg-gray-100"
              aria-label="Increase videos"
            >
              <ChevronUp className="w-4 h-4" />
            </button>
          </div>

          <div className="grid grid-cols-3 gap-2">
            {[3, 5, 10, 25, 50, 100].map((n) => (
              <button
                key={n}
                onClick={() => {
                  setValue(n);
                  setOpen(false);
                }}
                className="py-2 px-2 rounded-lg bg-gray-50 hover:bg-gray-100 text-sm font-medium"
              >
                {n}
              </button>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// --- Component for Catalogue Video Details ---
const CatalogueVideoDetails = ({
  description,
  setDescription,
  title,
  setTitle,
  MAX_CHARS,
  catalogueStep,
  targetVideos,
  setTargetVideos,
  themes,
  setThemes,
}) => {
  if (catalogueStep === 1) {
    return (
      <div className="space-y-8">
        <div className="flex items-center justify-between text-sm text-gray-600">
          <span className="italic">Using the Description and Title you entered above for this catalogue.</span>
          <button
            type="button"
            className="ml-4 text-sm font-medium text-[var(--color-accent)] hover:underline"
            onClick={() => {
              const el = document.getElementById("description-input");
              if (el) {
                el.scrollIntoView({ behavior: "smooth", block: "center" });
                el.focus();
                el.classList.add("jump-highlight");
                setTimeout(() => el.classList.remove("jump-highlight"), 900);
              }
            }}
          >
            Edit
          </button>
        </div>
      </div>
    );
  }

  if (catalogueStep === 2) {
    return (
      <div className="space-y-8">
        <div className="flex items-center text-sm font-normal text-[var(--color-accent)]">
          <Check className="w-4 h-4 mr-2 text-[var(--color-accent)]" />
          <span className="tracking-tight">Catalogue selected — set target videos and themes.</span>
        </div>

        <div className="flex items-center justify-between text-sm text-gray-600">
          <span className="italic">Using the Description and Title you entered above for this catalogue.</span>
          <button
            type="button"
            className="ml-4 text-sm font-medium text-[var(--color-accent)] hover:underline"
            onClick={() => {
              const el = document.getElementById("description-input");
              if (el) {
                el.scrollIntoView({ behavior: "smooth", block: "center" });
                el.focus();
                el.classList.add("jump-highlight");
                setTimeout(() => el.classList.remove("jump-highlight"), 900);
              }
            }}
          >
            Edit
          </button>
        </div>

        <div>
          <label className="text-gray-800 font-semibold text-base block mb-3">
            How many videos would you like?
          </label>

          {/* Compact editable dropdown like episodes */}
          <CatalogueTargetDropdown
            value={targetVideos}
            setValue={setTargetVideos}
          />
        </div>

        <div>
          <label className="text-gray-800 font-semibold text-base block mb-3">
            Which themes or categories should we cover?
          </label>
          <textarea
            rows="4"
            placeholder="List the themes or categories to cover (e.g., 'Breakfast, Lunch, Dinner, Snacks')"
            value={themes}
            onChange={(e) => setThemes(e.target.value)}
            className="w-full p-4 text-gray-700 border border-gray-200 rounded-xl focus:ring-0 focus:border-gray-300 outline-none text-base"
          ></textarea>
        </div>
      </div>
    );
  }
  return null;
};

// --- Component for Privacy Settings ---
const PrivacySettingsStep = ({ selectedPrivacy, setSelectedPrivacy, prevStepCompleted = false }) => {
  const options = [
    {
      id: "public",
      label: "Public",
      icon: Globe,
      desc: "Visible to everyone",
      price: null,
    },
    {
      id: "unlisted",
      label: "Unlisted",
      icon: LinkIcon,
      desc: "Only people with the link",
      price: "+$5.99",
    },
    {
      id: "private",
      label: "Private",
      icon: Lock,
      desc: "Only you",
      price: null,
    },
  ];

  const [open, setOpen] = useState(false);
  const containerRef = useRef(null);
  // Run the outline animation whenever no privacy option is selected
  const runAnim = !selectedPrivacy;

  return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
          <div className="space-y-2 text-left">
            <div className="relative" ref={containerRef}>
              <style>{`
                .privacy-outline-svg { position: absolute; inset: 0; pointer-events: none; overflow: visible; }
                .privacy-outline-base { stroke: rgba(226,232,240,1); stroke-width: 1.5; fill: none; stroke-linejoin: round; }

                /* Perimeter for rect(97x37) = 2*(97+37) = 268
                   The short "moving snake" length is increased to 597 (3×199)
                   so the animated gradient band appears longer while still
                   remaining shorter than the full perimeter. */
                /* Tail (gradient) - use the longer moving band length (597) */
                .privacy-outline-accent {
                  stroke: url(#privacyGrad);
                  stroke-width: 3.0;
                  fill: none;
                  stroke-linejoin: round;
                  stroke-linecap: round;
                  /* moving band length (199) — keep <= perimeter so animation is visible */
                  stroke-dasharray: 199;
                  stroke-dashoffset: 0;
                  opacity: 1;
                  transform-origin: center;
                }
                .privacy-outline-accent.run {
                  opacity: 1;
                  animation: privacy-run 2400ms cubic-bezier(.2,.9,.2,1) infinite;
                }

                /* moving rect styling (explicit) - prevents small square artifacts at corners */
                .privacy-outline-mover {
                  stroke: url(#privacyGrad);
                  stroke-width: 3.0;
                  fill: none;
                  stroke-linejoin: round;
                  stroke-linecap: round;
                  /* match moving band length so animation is visible */
                  stroke-dasharray: 199;
                  stroke-dashoffset: 0;
                  opacity: 1;
                }
                .privacy-outline-mover.run {
                  animation: privacy-run 2400ms cubic-bezier(.2,.9,.2,1) infinite;
                }

                /* Head (solid comet) sits on top of the moving tail and gives a moving point */
                .privacy-outline-head {
                  stroke: var(--color-accent);
                  stroke-width: 4.0;
                  fill: none;
                  stroke-linecap: round;
                  /* head length (24) + gap so total equals the moving band (199) */
                  stroke-dasharray: 24 175; /* 24 + 175 = 199 */
                  stroke-dashoffset: 0;
                  opacity: 1.0;
                }
                .privacy-outline-head.run {
                  opacity: 1;
                  animation: privacy-run 2400ms cubic-bezier(.2,.9,.2,1) infinite;
                }

                /* move dashoffset negative to travel clockwise around the rect
                   use the new moving band length (597) for a full loop offset */
                @keyframes privacy-run {
                  from { stroke-dashoffset: 0; }
                  to { stroke-dashoffset: -199; }
                }
              `}</style>

              <button
                type="button"
                onClick={() => setOpen((s) => !s)}
                className="w-full flex items-center justify-between p-4 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm relative overflow-visible"
                aria-haspopup="listbox"
                aria-expanded={open}
                style={{ zIndex: 1 }}
              >
                <div className="text-left">
                  <div className="text-gray-800 font-semibold text-base block tracking-tight">Who should be able to see your video?</div>
                  <div className="text-sm text-gray-500">{(options.find((o) => o.id === selectedPrivacy) || {}).label || "Select visibility"}</div>
                </div>
                <ChevronDown className="w-4 h-4 text-gray-500" />
              </button>

              {/* SVG overlay for animated outline (gradient tail + head) */}
              <svg className="privacy-outline-svg" viewBox="0 0 100 40" preserveAspectRatio="none" aria-hidden>
                <defs>
                  <linearGradient id="privacyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="transparent" stopOpacity="0" />
                    <stop offset="8%" stopColor="var(--color-accent)" stopOpacity="0.18" />
                    <stop offset="30%" stopColor="var(--color-accent)" stopOpacity="0.95" />
                    <stop offset="80%" stopColor="var(--color-accent)" stopOpacity="0.4" />
                    <stop offset="100%" stopColor="transparent" stopOpacity="0" />
                  </linearGradient>
                  {/* clip path inset slightly so animated strokes don't draw sharp corner pixels */}
                  <clipPath id="privacyClip">
                    <rect x="2.5" y="2.5" width="95" height="35" rx="11" />
                  </clipPath>
                </defs>

                <rect x="1.5" y="1.5" width="97" height="37" rx="12" className="privacy-outline-base" />

                {/* static tail that covers ~80% before the snake moves */}
                <rect x="1.5" y="1.5" width="97" height="37" rx="12" className="privacy-outline-accent" clipPath="url(#privacyClip)" strokeLinecap="round" strokeLinejoin="round" stroke="url(#privacyGrad)" strokeWidth="3" />

                {/* moving gradient band (the snake motion) */}
                <rect
                  x="1.5"
                  y="1.5"
                  width="97"
                  height="37"
                  rx="12"
                  className={`privacy-outline-mover ${runAnim ? 'run' : ''}`}
                  clipPath="url(#privacyClip)"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  stroke="url(#privacyGrad)"
                  strokeWidth="3"
                />

                {/* head: a small solid dash that travels ahead of the mover to create a comet effect */}
                <rect x="1.5" y="1.5" width="97" height="37" rx="12" className={`privacy-outline-head ${runAnim ? 'run' : ''}`} clipPath="url(#privacyClip)" strokeLinecap="round" strokeLinejoin="round" stroke="var(--color-accent)" strokeWidth="4" />
              </svg>

              {open && (
                <div className="absolute z-20 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg">
                  <ul role="listbox" className="divide-y divide-gray-100">
                    {options.map((opt) => (
                      <li
                        key={opt.id}
                        role="option"
                        tabIndex={0}
                        aria-selected={selectedPrivacy === opt.id}
                        onClick={() => {
                          setSelectedPrivacy(opt.id);
                          setOpen(false);
                        }}
                        onKeyDown={(e) => {
                          if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            setSelectedPrivacy(opt.id);
                            setOpen(false);
                          }
                        }}
                        className="p-3 flex items-start cursor-pointer hover:bg-gray-50"
                      >
                        <opt.icon className={`w-5 h-5 mr-3 mt-0.5 ${selectedPrivacy === opt.id ? "text-[var(--color-gold)]" : "text-gray-400"}`} />
                        <div className="flex-1">
                          <div className="flex justify-between items-center">
                            <div className={`text-sm font-medium ${selectedPrivacy === opt.id ? "text-gray-900" : "text-gray-700"}`}>
                              {opt.label}
                            </div>
                            {opt.price && <div className="text-sm font-normal text-gray-900">{opt.price}</div>}
                          </div>
                          <div className="text-xs text-gray-500 mt-0.5">{opt.desc}</div>
                        </div>
                        {selectedPrivacy === opt.id && (
                          <div className="ml-3 mt-0.5">
                            <Check className="w-4 h-4 text-[var(--color-gold)]" />
                          </div>
                        )}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
        </div>
      );
};

// --- Component for Review Request ---
const ReviewRequestStep = ({
  title,
  description,
  selectedDeliveryType,
  selectedTones,
  selectedVideoLength,
  customVideoLength,
  selectedPrivacy,
  // Specific props (may be undefined depending on flow)
  selectedFrequency,
  customRecurrentDates,
  numberOfEpisodes,
  selectedReleaseSchedule,
  customSeriesDates,
  targetVideos,
  themes,
  uploadedFiles,
  referenceLinks,
  customPrice,
  setCustomPrice,
  editingPrice,
  setEditingPrice,
  priceInput,
  setPriceInput,
  priceInputRef,
  savePrice,
  displayPrice,
  sanitizePriceInput,
  onEdit,
}) => {
  // Helper: format simple selection keys into readable labels
  const formatLabel = (key) => {
    const map = {
      daily: "Daily",
      weekly: "Weekly",
      biweekly: "Biweekly",
      monthly: "Monthly",
      custom: "Custom",
      immediate: "Immediate",
      "one-off": "One-off",
    };
    return map[key] || key;
  };

  // Helper: map video length keys to human friendly labels
  const getLengthLabel = () => {
    const map = {
      "short-form": "Short Form (15s – 1m)",
      standard: "Standard (2–5 min)",
      extended: "Extended (6–15 min)",
      "long-form": "Long Form (16–30+ min)",
    };
    return map[selectedVideoLength] || selectedVideoLength;
  };

  const getPrivacyLabel = () => {
    const map = {
      public: "Public",
      unlisted: "Unlisted (+$5.99)",
      private: "Private (+$9.99)",
    };
    return map[selectedPrivacy] || selectedPrivacy;
  };

  // Preview expand/collapse state to match RequestCard behavior
  const [previewExpanded, setPreviewExpanded] = useState(false);
  const PREVIEW_MAX_LENGTH = 120;
  const needsPreviewTruncation =
    description && description.length > PREVIEW_MAX_LENGTH;
  const displayedPreviewDescription =
    previewExpanded || !needsPreviewTruncation
      ? description
      : description
      ? description.substring(0, PREVIEW_MAX_LENGTH) + "..."
      : "";
  const togglePreviewExpanded = () => setPreviewExpanded((prev) => !prev);

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="text-center space-y-2">
        <h2 className="text-lg font-semibold text-gray-800">
          Review Your Request
        </h2>
        <p className="text-sm text-gray-500">
          Check everything before submitting
        </p>
      </div>
      {/* Inline preview card removed — use the See Preview modal only. */}
      <div className="bg-gray-50 rounded-xl p-5 space-y-4 border border-gray-200 text-sm text-left">
        {/* Core Details (reordered: Description → Title → Format) */}
        <div className="grid grid-cols-1 gap-4 border-b border-gray-200 pb-4">
          <div>
            <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
              Description
            </h3>
            <p
              className="text-gray-700"
              style={{
                whiteSpace: "pre-wrap",
                wordBreak: "break-word",
                maxHeight: "10rem",
                overflow: "auto",
              }}
            >
              {description}
            </p>
          </div>
          <div>
            <h3 className="sr-only">Title</h3>
            <p className="text-lg font-semibold text-gray-900" aria-label="Request title" style={{ overflowWrap: "anywhere", wordBreak: "break-word" }}>
              {title}
            </p>
          </div>
          <div>
            <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
              Format
            </h3>
            <p className="text-gray-900 font-medium capitalize">
              {selectedDeliveryType}
            </p>
          </div>
        </div>

        {/* Specific Details based on Type */}
        <div className="grid grid-cols-2 gap-4 border-b border-gray-200 pb-4">
          {selectedDeliveryType === "recurrent" && (
            <div className="col-span-2">
                <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
                  Frequency
                </h3>
              <p className="text-gray-900">
                {selectedFrequency === "custom"
                  ? `Custom (${
                      customRecurrentDates?.length || 0
                    } dates selected)`
                  : formatLabel(selectedFrequency)}
              </p>
            </div>
          )}

          {selectedDeliveryType === "series" && (
            <>
              <div>
                <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
                  Episodes
                </h3>
                <p className="text-gray-900">{numberOfEpisodes}</p>
              </div>
              <div>
                <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
                  Schedule
                </h3>
                <p className="text-gray-900">
                  {selectedReleaseSchedule === "custom"
                    ? `Custom (${customSeriesDates?.length || 0} dates)`
                    : formatLabel(selectedReleaseSchedule)}
                </p>
              </div>
            </>
          )}

          {selectedDeliveryType === "catalogue" && (
            <>
              <div>
                <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
                  Target Videos
                </h3>
                <p className="text-gray-900">{targetVideos}</p>
              </div>
              <div className="col-span-2">
                <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
                  Themes
                </h3>
                <p className="text-gray-700">{themes || "None specified"}</p>
              </div>
            </>
          )}
        </div>

        {/* Creative Details */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
              Length
            </h3>
            <p className="text-gray-900">{getLengthLabel()}</p>
          </div>
          <div>
            <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
              Privacy
            </h3>
            <p className="text-gray-900">{getPrivacyLabel()}</p>
          </div>
          <div className="col-span-2">
            <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
              Budget
            </h3>
            <div>
              {editingPrice ? (
                <div className="flex items-center">
                  <span className="text-gray-700 mr-2 font-semibold">$</span>
                  <input
                    type="text"
                    inputMode="decimal"
                    pattern="^\d*(\.\d{0,2})?$"
                    value={priceInput}
                    onChange={(e) =>
                      setPriceInput(sanitizePriceInput(e.target.value))
                    }
                    onKeyDown={(e) => {
                      if (e.key === "Enter") {
                        e.preventDefault();
                        savePrice();
                      }
                    }}
                    onBlur={() => savePrice()}
                    ref={priceInputRef}
                    className="p-2 rounded-lg border border-gray-200 text-sm w-32"
                  />
                </div>
              ) : (
                <button
                  onClick={() => {
                    setPriceInput((displayPrice || 0).toFixed(2));
                    setEditingPrice(true);
                  }}
                  className="text-sm font-normal text-gray-900 bg-[var(--surface)] border border-gray-100 rounded px-3 py-2"
                >
                  {"$" + (displayPrice || 0).toFixed(2)}
                </button>
              )}
            </div>
          </div>

          {selectedTones && selectedTones.length > 0 && (
            <div className="col-span-2">
              <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-1">
                Tone & Style
              </h3>
              <div className="flex flex-wrap gap-2">
                {selectedTones.map((t) => (
                  <span
                    key={t}
                    className="px-2 py-1 bg-[var(--surface)] border border-gray-200 rounded text-xs text-gray-600 capitalize"
                  >
                    {t}
                  </span>
                ))}
              </div>
            </div>
          )}

          {(uploadedFiles?.length > 0 || referenceLinks?.length > 0) && (
            <div className="col-span-2 border-t border-gray-200 pt-4 mt-2">
              <h3 className="text-xs font-normal text-gray-500 uppercase tracking-wider mb-2">
                References
              </h3>
              {uploadedFiles?.length > 0 && (
                <div className="mb-2">
                  <span className="text-xs text-gray-400 block mb-1">
                    Files:
                  </span>
                  <ul className="list-disc list-inside text-xs text-gray-600">
                    {uploadedFiles.map((f, i) => (
                      <li key={i} className="truncate">
                        {f.name}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
              {referenceLinks?.length > 0 && (
                <div>
                  <span className="text-xs text-gray-400 block mb-1">
                    Links:
                  </span>
                  <ul className="list-disc list-inside text-xs text-blue-600">
                    {referenceLinks.map((l, i) => (
                      <li key={i} className="truncate">
                        {l}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
      <button
        onClick={onEdit}
        className="w-full py-3 text-sm text-gray-500 hover:text-gray-700 underline"
      >
        Edit Request
      </button>
    </div>
  );
};

// --- Main Booking Page Component ---
const App = () => {
  // Constants for text input
  const MAX_CHARS = 300;
  const MIN_CHARS = 10;
  const MIN_TITLE_CHARS = 5; // show Tone & Style after this many title chars

  // Form State
  const [selectedDeliveryType, setSelectedDeliveryType] = useState(null);
  const [deliveryDropdownOpen, setDeliveryDropdownOpen] = useState(false);
  const [isTransitioning, setIsTransitioning] = useState(false); // Added transition state
  const [description, setDescription] = useState("");
  const [title, setTitle] = useState(() => {
    try {
      const params = new URLSearchParams(window.location.search || "");
      // Prefer `q`, then legacy `term`, then `search` for compatibility
      return (
        params.get("q") || params.get("term") || params.get("search") || ""
      );
    } catch (e) {
      return "";
    }
  }); // Initialize title from ?q= (falls back to term/search)
  const [touchedDescription, setTouchedDescription] = useState(false);
  const [isDraftLoaded, setIsDraftLoaded] = useState(false);

  // NEW STATES
  const [customVideoLength, setCustomVideoLength] = useState("");
  const [uploadedFiles, setUploadedFiles] = useState([]);
  const [referenceLinks, setReferenceLinks] = useState([]);

  // One-Time Flow State
  const [oneTimeStep, setOneTimeStep] = useState(1);

  // Recurrent Flow State
  const [recurrentStep, setRecurrentStep] = useState(1);
  const [selectedFrequency, setSelectedFrequency] = useState(null);
  const [customRecurrentDates, setCustomRecurrentDates] = useState([]); // New State

  // SERIES FLOW STATE
  const [seriesStep, setSeriesStep] = useState(1);
  const [numberOfEpisodes, setNumberOfEpisodes] = useState(5);
  const [selectedReleaseSchedule, setSelectedReleaseSchedule] = useState(null);
  const [customSeriesDates, setCustomSeriesDates] = useState([]); // New State

  // NEW CATALOGUE FLOW STATE
  const [catalogueStep, setCatalogueStep] = useState(1); // 1: Idea/Description, 2: Config, 3: Success
  const [targetVideos, setTargetVideos] = useState(0); // Default value: start at 0 so price shows $0.00
  // Allow overriding the calculated price with an editable custom price
  const [customPrice, setCustomPrice] = useState(null); // number in dollars, or null to use calc
  const [editingPrice, setEditingPrice] = useState(false);
  const [priceInput, setPriceInput] = useState("0.00");
  const priceInputRef = useRef(null);
  // Payment modal / pending submission state
  const [paymentModalOpen, setPaymentModalOpen] = useState(false);
  const [pendingSubmission, setPendingSubmission] = useState(null); // { flow: 'one-time'|'series'|'recurrent'|'catalogue', nextStep: number }
  const [paymentAmount, setPaymentAmount] = useState(25); // default recommended preset (Most Popular)
  const [paymentRole, setPaymentRole] = useState("creator"); // 'creator' or 'expert'
  const PAYMENT_PRESETS = [15, 25, 50, 100];
  const [selectedCreator, setSelectedCreator] = useState(null);
  const [creatorSearch, setCreatorSearch] = useState("");
  const [chooseCreatorExpanded, setChooseCreatorExpanded] = useState(false);

  // Show the Format / Examples section a short moment after the Tone section appears.
  const [showFormatSection, setShowFormatSection] = useState(false);
  const _showFormatTimer = useRef(null);
  const [showExamples, setShowExamples] = useState(false);
  const _showExamplesTimer = useRef(null);
  // Format-selection followups
  const [formatSelectedMessage, setFormatSelectedMessage] = useState(null);
  const [showFormatExamples, setShowFormatExamples] = useState(false);
  const _formatMessageTimer = useRef(null);
  const _formatExamplesTimer = useRef(null);
  // Delivery dropdown refs & timers for auto-open + focus (one-tap selection)
  const deliveryListRef = useRef(null);
  const deliveryAutoOpenTimer = useRef(null);
  const deliveryFocusTimer = useRef(null);

  // Auto-open delivery dropdown when the Examples box appears (one-tap friendly)
  useEffect(() => {
    if (showExamples && !selectedDeliveryType) {
      if (deliveryAutoOpenTimer.current) clearTimeout(deliveryAutoOpenTimer.current);
      deliveryAutoOpenTimer.current = setTimeout(() => {
        setDeliveryDropdownOpen(true);
        if (deliveryFocusTimer.current) clearTimeout(deliveryFocusTimer.current);
        deliveryFocusTimer.current = setTimeout(() => {
          try {
            if (deliveryListRef.current) {
              const first = deliveryListRef.current.querySelector('[role="option"]');
              if (first && typeof first.focus === 'function') first.focus();
            }
          } catch (e) {}
        }, 480);
      }, 720);
    } else {
      if (deliveryAutoOpenTimer.current) { clearTimeout(deliveryAutoOpenTimer.current); deliveryAutoOpenTimer.current = null; }
    }
    return () => {
      if (deliveryAutoOpenTimer.current) { clearTimeout(deliveryAutoOpenTimer.current); deliveryAutoOpenTimer.current = null; }
      if (deliveryFocusTimer.current) { clearTimeout(deliveryFocusTimer.current); deliveryFocusTimer.current = null; }
    };
  }, [showExamples, selectedDeliveryType]);

  useEffect(() => {
    if (title && title.length >= MIN_TITLE_CHARS) {
      if (_showFormatTimer.current) clearTimeout(_showFormatTimer.current);
      _showFormatTimer.current = setTimeout(() => setShowFormatSection(true), 1000);
      // schedule examples to appear when the user scrolls near the format/delivery box
      // Prefer IntersectionObserver so examples reveal when the user approaches the control.
      if (_showExamplesTimer.current) {
        try {
          if (_showExamplesTimer.current instanceof IntersectionObserver) {
            _showExamplesTimer.current.disconnect();
          } else {
            clearTimeout(_showExamplesTimer.current);
          }
        } catch (e) {}
        _showExamplesTimer.current = null;
      }

      try {
        if (typeof IntersectionObserver !== "undefined" && deliveryListRef.current) {
          const obs = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  setShowExamples(true);
                  try { obs.disconnect(); } catch (e) {}
                  _showExamplesTimer.current = null;
                }
              });
            },
            { root: null, rootMargin: "0px 0px 400px 0px", threshold: 0 }
          );
          obs.observe(deliveryListRef.current);
          _showExamplesTimer.current = obs;
        } else {
          // Fallback: shorter delay (twice as fast as previous) so it appears earlier on browsers without IntersectionObserver
          _showExamplesTimer.current = setTimeout(() => setShowExamples(true), 6100);
        }
      } catch (e) {
        // final fallback
        _showExamplesTimer.current = setTimeout(() => setShowExamples(true), 6100);
      }
    } else {
      if (_showFormatTimer.current) {
        clearTimeout(_showFormatTimer.current);
        _showFormatTimer.current = null;
      }
      setShowFormatSection(false);
      if (_showExamplesTimer.current) {
        try {
          if (_showExamplesTimer.current instanceof IntersectionObserver) {
            _showExamplesTimer.current.disconnect();
          } else {
            clearTimeout(_showExamplesTimer.current);
          }
        } catch (e) {}
        _showExamplesTimer.current = null;
      }
      setShowExamples(false);
    }
    return () => {
      if (_showFormatTimer.current) {
        clearTimeout(_showFormatTimer.current);
        _showFormatTimer.current = null;
      }
      if (_showExamplesTimer.current) {
        try {
          if (_showExamplesTimer.current instanceof IntersectionObserver) {
            _showExamplesTimer.current.disconnect();
          } else {
            clearTimeout(_showExamplesTimer.current);
          }
        } catch (e) {}
        _showExamplesTimer.current = null;
      }
    };
  }, [title, MIN_TITLE_CHARS]);

  // When a delivery format is selected, show a short message then examples after delays
  useEffect(() => {
    if (selectedDeliveryType) {
      // clear any previous timers
      if (_formatMessageTimer.current) clearTimeout(_formatMessageTimer.current);
      if (_formatExamplesTimer.current) clearTimeout(_formatExamplesTimer.current);
      setFormatSelectedMessage(null);
      setShowFormatExamples(false);

      // show a short confirmation message after 1600ms
      _formatMessageTimer.current = setTimeout(() => {
        const map = {
          series: "Series selected — now configure episode details.",
          catalogue: "Catalogue selected — set target videos and themes.",
          recurrent: "Recurrent selected — choose a delivery frequency.",
          "one-time": "One-Time selected — next step: Tone & Style.",
        };
        setFormatSelectedMessage(map[selectedDeliveryType] || null);
      }, 400);

      // show examples for the chosen format a bit later (visible, note + edit)
      _formatExamplesTimer.current = setTimeout(() => {
        setShowFormatExamples(true);
      }, 4800);
    } else {
      if (_formatMessageTimer.current) clearTimeout(_formatMessageTimer.current);
      if (_formatExamplesTimer.current) clearTimeout(_formatExamplesTimer.current);
      _formatMessageTimer.current = null;
      _formatExamplesTimer.current = null;
      setFormatSelectedMessage(null);
      setShowFormatExamples(false);
    }
    return () => {
      if (_formatMessageTimer.current) { clearTimeout(_formatMessageTimer.current); _formatMessageTimer.current = null; }
      if (_formatExamplesTimer.current) { clearTimeout(_formatExamplesTimer.current); _formatExamplesTimer.current = null; }
    };
  }, [selectedDeliveryType]);

  // Inject shimmer / gradient CSS once so preview uses the same styles as other pages
  useEffect(() => {
    try {
      if (document.getElementById('ideas-theme-styles')) return;
      const css = `
        :root { --brand-gold: var(--color-gold); --color-gold-cream: rgba(255, 242, 199, 1); }
        @keyframes shimmer-gold-premium { 0% { background-position: 100% 0; } 40% { background-position: 0% 0; } 100% { background-position: 0% 0; } }
        .shimmer-gold { background: linear-gradient(100deg, var(--color-gold) 0%, var(--color-gold) 42%, var(--color-gold-cream) 45%, var(--color-gold-cream) 55%, var(--color-gold) 58%, var(--color-gold) 100%); background-size: 300% 100%; animation: shimmer-gold-premium 3s ease-in-out infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 var(--color-gold); } 70% { box-shadow: 0 0 0 12px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
        .pulse-price { animation: pulse-ring 2.2s infinite; }

        /* Sweeping text: white overlay that passes over the heading without tinting it.
           Use an isolated white gradient and blend where helpful to avoid using the
           accent color for the sweep itself. */
        .sweeping-text-container { position: relative; display: inline-block; overflow: hidden; z-index: 1; }
        .sweep-effect { position: absolute; top: 0; left: -40%; height: 100%; width: 60%; pointer-events: none; border-radius: 8px;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.95) 50%, rgba(255,255,255,0) 100%);
            mix-blend-mode: normal; transform: translateX(0); animation: sweep-anim 2000ms ease-in-out forwards; z-index: 0; }
        @keyframes sweep-anim { 0% { transform: translateX(-120%); opacity: 0; } 8% { opacity: 1; } 85% { transform: translateX(120%); opacity: 1; } 100% { transform: translateX(120%); opacity: 0; } }
        /* Ensure the Ideas page elements adopt the page background so inputs and panels blend */
        .ideas-root .bg-white { background-color: var(--surface) !important; box-shadow: none !important; }
        .ideas-root input, .ideas-root textarea, .ideas-root select, .ideas-root .rounded-xl, .ideas-root .rounded-2xl { background-color: #F8F8FA !important; }
        .ideas-root .border-gray-200 { border-color: rgba(15,23,42,0.06) !important; }

        /* Ensure no other headings or input text exceed the "Give a title to your video" size
           The title label uses text-base (~1rem). Cap h2/h3/h4 and form input sizes to 1rem. */
        .ideas-root h2,
        .ideas-root h3,
        .ideas-root h4,
        .ideas-root h5,
        .ideas-root .text-lg,
        .ideas-root .text-xl,
        .ideas-root .text-2xl,
        .ideas-root input,
        .ideas-root textarea,
        .ideas-root label {
          font-size: 1rem !important;
          line-height: 1.2 !important;
        }

        /* Exclude the main animated page title (keeps its larger size) */
        .ideas-root .cream-glow-box h1 { font-size: 30px !important; line-height: 1.05 !important; }
      `;
      const style = document.createElement('style');
      style.id = 'ideas-theme-styles';
      style.appendChild(document.createTextNode(css));
      document.head.appendChild(style);
    } catch (e) {
      // ignore
    }
  }, []);
  const chooseCreatorInputRef = useRef(null);
  // Sample creators list (replace with real data or API later)
  const CREATORS_SAMPLE = [
    { id: "alice", name: "@alice" },
    { id: "ben", name: "@ben" },
    { id: "carla", name: "@carla" },
    { id: "darin", name: "@darin" },
    { id: "elena", name: "@elena" },
    { id: "frank", name: "@frank" },
  ];
  // Filter creators so that a visible leading '@' is respected.
  const filteredCreators = (() => {
    const raw = String(creatorSearch || "").trim();
    if (!raw) return CREATORS_SAMPLE;
    // If user typed with or without '@', normalize to include '@' when searching
    const query = raw.startsWith("@")
      ? raw.toLowerCase()
      : "@" + raw.toLowerCase();
    return CREATORS_SAMPLE.filter((c) => c.name.toLowerCase().includes(query));
  })();

  // Prevent background scroll and ensure backdrop covers everything when payment modal is open
  useEffect(() => {
    try {
      if (paymentModalOpen) {
        // lock background scroll
        document.body.style.overflow = "hidden";
        document.body.style.touchAction = "none";
      } else {
        document.body.style.overflow = "";
        document.body.style.touchAction = "";
      }
    } catch (e) {
      // ignore in non-browser env
    }

    return () => {
      try {
        document.body.style.overflow = "";
        document.body.style.touchAction = "";
      } catch (e) {}
    };
  }, [paymentModalOpen]);

  // Lightweight analytics hook (replace with real analytics integration)
  const trackEvent = (eventName, payload = {}) => {
    try {
      // Placeholder for real analytics; keep concise logs for debugging
      console.log("[analytics]", eventName, payload);
    } catch (e) {
      /* ignore */
    }
  };

  // Focus the choose-creator input when the chooser expands
  useEffect(() => {
    if (chooseCreatorExpanded) {
      // If there is an existing selected creator, pre-fill the input so it can be edited
      try {
        if (selectedCreator) {
          setCreatorSearch(
            String(selectedCreator.name || "").replace(/^@+/, "")
          );
        }
      } catch (e) {}
      setTimeout(() => {
        if (chooseCreatorInputRef.current)
          chooseCreatorInputRef.current.focus();
      }, 240);
    }
  }, [chooseCreatorExpanded, selectedCreator]);

  // Derived display price: either custom override or default to 0
  // NOTE: keep default at $0.00 unless the user explicitly edits the price
  const displayPrice = typeof customPrice === "number" ? customPrice : 0;

  useEffect(() => {
    if (editingPrice) {
      setPriceInput((displayPrice || 0).toFixed(2));
      setTimeout(() => {
        if (priceInputRef.current) priceInputRef.current.focus();
      }, 0);
    }
  }, [editingPrice]);

  // Format an integer/decimal string with thousand separators for the input
  const formatWithCommas = (numStr) => {
    if (!numStr) return "";
    const [intPart, decPart] = numStr.split(".");
    const intClean = intPart.replace(/^0+(?=\d)/, "") || "0";
    const intFormatted = intClean.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return decPart !== undefined ? `${intFormatted}.${decPart}` : intFormatted;
  };

  const sanitizePriceInput = (raw) => {
    if (raw == null) return "";
    // Remove everything except digits and dot
    let v = String(raw).replace(/[^0-9.]/g, "");
    // Keep only first dot
    const parts = v.split(".");
    if (parts.length > 1) {
      v = parts[0] + "." + parts.slice(1).join("");
    }
    // Limit to 2 decimal places for fractional part
    if (v.includes(".")) {
      const [a, b] = v.split(".");
      const dec = (b || "").slice(0, 2);
      return formatWithCommas(a) + (dec.length ? `.${dec}` : ".");
    }
    return formatWithCommas(v);
  };

  const formatNumberToInput = (num) => {
    if (num == null || isNaN(num)) return "";
    // Force two decimals for stored/input initial value
    const fixed = Number(num).toFixed(2);
    const [intPart, dec] = fixed.split(".");
    return intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "." + dec;
  };

  const savePrice = () => {
    const parsed = parseFloat(
      String(priceInput || "")
        .replace(/,/g, "")
        .replace(/[^0-9.-]/g, "")
    );
    const final = isNaN(parsed) ? 0 : parsed;
    setCustomPrice(final);
    setPriceInput(formatNumberToInput(final));
    setEditingPrice(false);
  };
  // Toast helper for small confirmations
  const [toastMessage, setToastMessage] = useState("");
  const showToast = (msg) => {
    try {
      setToastMessage(msg);
    } catch (e) {}
  };
  useEffect(() => {
    if (!toastMessage) return;
    const t = setTimeout(() => setToastMessage(""), 8000);
    return () => clearTimeout(t);
  }, [toastMessage]);
  // Save creator from the freeform input (either save and close or keep open)
  const saveCreatorFromInput = (close = true) => {
    try {
      const raw = String(creatorSearch || "").trim();
      if (!raw) return;
      const id = raw.replace(/^@+/, "").toLowerCase();
      if (!id) return;
      const c = { id, name: "@" + id };
      setSelectedCreator(c);
      setPaymentRole("creator");
      trackEvent("creator_saved", { creatorId: id, source: "manual" });
      showToast(`Saved ${c.name}`);
      if (close) setChooseCreatorExpanded(false);
    } catch (e) {
      // ignore
    }
  };
  // Persist customPrice to localStorage so edits survive reloads
  const PRICE_STORAGE_KEY = "ideas_customPrice_v1";
  // Persist selected creator across openings/reloads
  const SELECTED_CREATOR_KEY = "ideas_selectedCreator_v1";

  // Load persisted price on first mount
  useEffect(() => {
    try {
      const raw = window.localStorage.getItem(PRICE_STORAGE_KEY);
      if (raw != null) {
        const parsed = parseFloat(raw);
        if (!isNaN(parsed)) {
          setCustomPrice(parsed);
          setPriceInput(parsed.toFixed(2));
        }
      }
    } catch (e) {
      // ignore storage errors
    }
  }, []);

  // Load persisted selected creator on mount
  useEffect(() => {
    try {
      const raw = window.localStorage.getItem(SELECTED_CREATOR_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && parsed.id) {
          setSelectedCreator(parsed);
        }
      }
    } catch (e) {
      // ignore
    }
  }, []);

  // Save persisted price whenever customPrice changes (or remove when null)
  useEffect(() => {
    try {
      if (typeof customPrice === "number") {
        window.localStorage.setItem(PRICE_STORAGE_KEY, String(customPrice));
      } else {
        window.localStorage.removeItem(PRICE_STORAGE_KEY);
      }
    } catch (e) {
      // ignore storage errors
    }
  }, [customPrice]);

  // Persist selected creator whenever it changes
  useEffect(() => {
    try {
      if (selectedCreator && selectedCreator.id) {
        window.localStorage.setItem(
          SELECTED_CREATOR_KEY,
          JSON.stringify(selectedCreator)
        );
      } else {
        window.localStorage.removeItem(SELECTED_CREATOR_KEY);
      }
    } catch (e) {
      // ignore
    }
  }, [selectedCreator]);
  const [themes, setThemes] = useState(""); // Default value

  // TONE & STYLE STATE (Shared)
  const [selectedTones, setSelectedTones] = useState([]);
  // STYLE state (separate picker)
  const [selectedStyles, setSelectedStyles] = useState([]);

  // VIDEO LENGTH STATE (Shared)
  const [selectedVideoLength, setSelectedVideoLength] = useState(null);

  // PRIVACY STATE (Shared)
  const [selectedPrivacy, setSelectedPrivacy] = useState(null);

  const [activeNav, setActiveNav] = useState("Ideas");
  // Modal state for floating preview (toggled by floating "See preview" button)
  const [previewModalOpen, setPreviewModalOpen] = useState(false);

  // Derived state for overall selection status (Only checks if *a* type is selected)
  const isFormatSelected = selectedDeliveryType !== null;

  // Delivery Options Data (Unchanged)
  const deliveryOptions = [
    {
      type: "one-time",
      title: "One-Time Video",
      subtitle: "A single standalone video.",
      Icon: Film,
    },
    {
      type: "recurrent",
      title: "Recurrent",
      subtitle: "A routine delivered daily, weekly, or monthly.",
      Icon: Repeat,
    },
    {
      type: "series",
      title: "Series",
      subtitle: "A focused set of connected videos.",
      Icon: ListVideo,
    },
    {
      type: "catalogue",
      title: "Catalogue",
      subtitle: "A curated mix across different themes.",
      Icon: Folder,
    },
  ];

  // Title Animation State (Unchanged)
  const titles = ["Book Your Next Videos", "Book What You'll Watch Next"];
  const [currentTitleIndex, setCurrentTitleIndex] = useState(0);
  const [titleVisible, setTitleVisible] = useState(true);
  const [sweepActive, setSweepActive] = useState(false);
  const titleBoxRef = useRef(null);
  const [titleBoxWidth, setTitleBoxWidth] = useState(null);
  const [titleGradient, setTitleGradient] = useState(null);

  // Animation Constants (milliseconds) (Unchanged)
  const SWEEP_DURATION = 8000;
  const FADE_DURATION = 2000;
  const SWEEP_START_DELAY = 400;

  // --- Title Animation Logic (Unchanged) ---
  useEffect(() => {
    let isMounted = true;
    let sweepStartTimeout, hideTitleTimeout, nextTitleChange;

    const cycle = () => {
      if (!isMounted) return;

      setTitleVisible(true);

        sweepStartTimeout = setTimeout(() => {
          setSweepActive(true);
        }, SWEEP_START_DELAY);

        hideTitleTimeout = setTimeout(() => {
          setSweepActive(false);
          setTitleVisible(false);
        }, SWEEP_START_DELAY + SWEEP_DURATION);

        nextTitleChange = setTimeout(() => {
          setCurrentTitleIndex((prevIndex) => (prevIndex + 1) % titles.length);
          cycle();
        }, SWEEP_START_DELAY + SWEEP_DURATION + FADE_DURATION);

      return () => {
        clearTimeout(sweepStartTimeout);
        clearTimeout(hideTitleTimeout);
        clearTimeout(nextTitleChange);
      };
    };

    cycle();

    return () => {
      isMounted = false;
    };
  }, [titles.length]);

  // Keep track of the title box width so related elements (time pill) can match it
  useEffect(() => {
    const update = () => {
      try {
        if (titleBoxRef.current) {
          setTitleBoxWidth(titleBoxRef.current.offsetWidth);
        }
      } catch (e) {}
    };
    update();
    window.addEventListener('resize', update);
    return () => window.removeEventListener('resize', update);
  }, [titleVisible, currentTitleIndex]);

  // Compute a gradient based on the active accent color variables so the title
  // fully reflects whatever accent the app/theme applies.
  useEffect(() => {
    try {
      const primary = getCssVar('--color-gold') || getCssVar('--brand-gold') || '#CA8A04';
      const secondary = getCssVar('--color-gold-600') || getCssVar('--brand-gold-600') || '#B27000';
      setTitleGradient(`linear-gradient(90deg, ${primary}, ${secondary})`);
    } catch (e) {
      setTitleGradient('linear-gradient(90deg, #CA8A04, #B27000)');
    }
  }, []);

  // --- Next Button Enablement Logic ---
  const isRecurrent = selectedDeliveryType === "recurrent";
  const isSeries = selectedDeliveryType === "series";
  const isCatalogue = selectedDeliveryType === "catalogue"; // NEW
  let isNextEnabled = false;

  if (selectedDeliveryType === "one-time") {
    if (oneTimeStep === 1) {
      isNextEnabled =
        description.length >= MIN_CHARS && title.trim().length > 0;
    } else if (oneTimeStep === 2) {
      isNextEnabled = true; // Tone step
    } else if (oneTimeStep === 3) {
      isNextEnabled = true; // Length step
    } else if (oneTimeStep === 4) {
      isNextEnabled = true; // References step (Optional)
    } else if (oneTimeStep === 5) {
      isNextEnabled = selectedPrivacy !== null; // Privacy step
    } else if (oneTimeStep === 6) {
      isNextEnabled = true; // Review step
    } else {
      isNextEnabled = false;
    }
  } else if (isRecurrent) {
    if (recurrentStep === 1) {
      isNextEnabled =
        description.length >= MIN_CHARS && title.trim().length > 0;
    } else if (recurrentStep === 2) {
      if (selectedFrequency === "custom") {
        isNextEnabled = customRecurrentDates.length > 0;
      } else {
        isNextEnabled = selectedFrequency !== null;
      }
    } else if (recurrentStep === 3) {
      isNextEnabled = true; // Tone step
    } else if (recurrentStep === 4) {
      isNextEnabled = true; // Length step
    } else if (recurrentStep === 5) {
      isNextEnabled = true; // References step (Optional)
    } else if (recurrentStep === 6) {
      isNextEnabled = selectedPrivacy !== null; // Privacy step
    } else if (recurrentStep === 7) {
      isNextEnabled = true; // Review step
    } else {
      isNextEnabled = false;
    }
  } else if (isSeries) {
    if (seriesStep === 1) {
      isNextEnabled =
        description.length >= MIN_CHARS && title.trim().length > 0;
    } else if (seriesStep === 2) {
      if (selectedReleaseSchedule === "custom") {
        isNextEnabled = numberOfEpisodes >= 1 && customSeriesDates.length > 0;
      } else {
        isNextEnabled =
          numberOfEpisodes >= 1 && selectedReleaseSchedule !== null;
      }
    } else if (seriesStep === 3) {
      isNextEnabled = true; // Tone step
    } else if (seriesStep === 4) {
      isNextEnabled = true; // Length step
    } else if (seriesStep === 5) {
      isNextEnabled = true; // References step (Optional)
    } else if (seriesStep === 6) {
      isNextEnabled = selectedPrivacy !== null; // Privacy step
    } else if (seriesStep === 7) {
      isNextEnabled = true; // Review step
    } else if (seriesStep === 8) {
      isNextEnabled = false;
    }
  } else if (isCatalogue) {
    // NEW CATALOGUE LOGIC
    if (catalogueStep === 1) {
      isNextEnabled =
        description.length >= MIN_CHARS && title.trim().length > 0; // Enables going to Step 2
    } else if (catalogueStep === 2) {
      isNextEnabled = targetVideos >= 1; // Enables final submission
    } else if (catalogueStep === 3) {
      isNextEnabled = true; // Tone step
    } else if (catalogueStep === 4) {
      isNextEnabled = true; // Length step
    } else if (catalogueStep === 5) {
      isNextEnabled = true; // References step (Optional)
    } else if (catalogueStep === 6) {
      isNextEnabled = selectedPrivacy !== null; // Privacy step
    } else if (catalogueStep === 8) {
      isNextEnabled = false; // Submission complete
    }
  }

  // --- Haptic Feedback State and Logic (Unchanged) ---
  const [isAnimating, setIsAnimating] = useState(false);
  const wasEnabledRef = useRef(false);

  useEffect(() => {
    if (!wasEnabledRef.current && isNextEnabled) {
      setIsAnimating(true);
      const timer = setTimeout(() => {
        setIsAnimating(false);
      }, 800);

      return () => clearTimeout(timer);
    }

    wasEnabledRef.current = isNextEnabled;
  }, [isNextEnabled]);

  // --- Progress calculation ---
  // Start at 30% by default so the UI shows initial progress rather than 0%.
  let progressPercentage = 30;

  if (isFormatSelected) {
    let currentStep = 1;
    let reviewStepIndex = 6; // Default for One-Time (Review is step 6)

    if (isRecurrent) {
      currentStep = recurrentStep;
      reviewStepIndex = 7;
    } else if (isSeries) {
      currentStep = seriesStep;
      reviewStepIndex = 7;
    } else if (isCatalogue) {
      currentStep = catalogueStep;
      reviewStepIndex = 7;
    } else {
      // One-Time
      currentStep = oneTimeStep;
      reviewStepIndex = 6;
    }

    if (currentStep >= reviewStepIndex) {
      progressPercentage = 100;
    } else {
      const start = 30;
      const range = 70;
      const fraction = (currentStep - 1) / (reviewStepIndex - 1);
      progressPercentage = start + fraction * range;
    }
  }
  // Estimate remaining time (in seconds) based on progress percentage (0-100).
  const remainingSeconds = Math.max(
    0,
    Math.round((1 - progressPercentage / 100) * 60)
  );

  // --- Active Button State Colors (Navy primary for premium brand) ---
  const ACTIVE_BG_COLOR = "var(--color-primary)";
  const ACTIVE_SHADOW = "0 2px 6px rgba(6, 24, 58, 0.18)";
  // -------------------------------------------------------------------

  const handleNext = () => {
    if (!isNextEnabled) {
      console.error("Cannot proceed: Please complete the required fields.");
      return;
    }

    if (isSeries) {
      if (seriesStep === 1) setSeriesStep(2);
      else if (seriesStep === 2) setSeriesStep(3); // To Tone
      else if (seriesStep === 3) setSeriesStep(4); // To Length
      else if (seriesStep === 4) setSeriesStep(5); // To References
      else if (seriesStep === 5) setSeriesStep(6); // To Privacy
      else if (seriesStep === 6) setSeriesStep(7); // To Review
      else if (seriesStep === 7) {
        // Open payment modal before final success
        setPendingSubmission({ flow: "series", nextStep: 8 });
        setPaymentAmount(Math.max(15, displayPrice || 0));
        setPaymentModalOpen(true);
      }
    } else if (isRecurrent) {
      if (recurrentStep === 1) setRecurrentStep(2);
      else if (recurrentStep === 2) setRecurrentStep(3); // To Tone
      else if (recurrentStep === 3) setRecurrentStep(4); // To Length
      else if (recurrentStep === 4) setRecurrentStep(5); // To References
      else if (recurrentStep === 5) setRecurrentStep(6); // To Privacy
      else if (recurrentStep === 6) setRecurrentStep(7); // To Review
      else if (recurrentStep === 7) {
        setPendingSubmission({ flow: "recurrent", nextStep: 8 });
        setPaymentAmount(Math.max(15, displayPrice || 0));
        setPaymentModalOpen(true);
      }
    } else if (isCatalogue) {
      if (catalogueStep === 1) setCatalogueStep(2);
      else if (catalogueStep === 2) setCatalogueStep(3); // To Tone
      else if (catalogueStep === 3) setCatalogueStep(4); // To Length
      else if (catalogueStep === 4) setCatalogueStep(5); // To References
      else if (catalogueStep === 5) setCatalogueStep(6); // To Privacy
      else if (catalogueStep === 6) setCatalogueStep(7); // To Review
      else if (catalogueStep === 7) {
        setPendingSubmission({ flow: "catalogue", nextStep: 8 });
        setPaymentAmount(Math.max(15, displayPrice || 0));
        setPaymentModalOpen(true);
      }
    } else {
      // One-Time
      if (oneTimeStep === 1) setOneTimeStep(2); // To Tone
      else if (oneTimeStep === 2) setOneTimeStep(3); // To Length
      else if (oneTimeStep === 3) setOneTimeStep(4); // To References
      else if (oneTimeStep === 4) setOneTimeStep(5); // To Privacy
      else if (oneTimeStep === 5) setOneTimeStep(6); // To Review
      else if (oneTimeStep === 6) {
        setPendingSubmission({ flow: "one-time", nextStep: 7 });
        setPaymentAmount(Math.max(15, displayPrice || 0));
        setPaymentModalOpen(true);
      }
    }
  };

  const handleBack = () => {
    if (isSeries) {
      if (seriesStep === 1) setSelectedDeliveryType(null);
      else if (seriesStep === 2) setSeriesStep(1);
      else if (seriesStep === 3) setSeriesStep(2);
      else if (seriesStep === 4) setSeriesStep(3);
      else if (seriesStep === 5) setSeriesStep(4);
      else if (seriesStep === 6) setSeriesStep(5);
      else if (seriesStep === 7) setSeriesStep(6);
    } else if (isRecurrent) {
      if (recurrentStep === 1) setSelectedDeliveryType(null);
      else if (recurrentStep === 2) setRecurrentStep(1);
      else if (recurrentStep === 3) setRecurrentStep(2);
      else if (recurrentStep === 4) setRecurrentStep(3);
      else if (recurrentStep === 5) setRecurrentStep(4);
      else if (recurrentStep === 6) setRecurrentStep(5);
      else if (recurrentStep === 7) setRecurrentStep(6);
    } else if (isCatalogue) {
      if (catalogueStep === 1) setSelectedDeliveryType(null);
      else if (catalogueStep === 2) setCatalogueStep(1);
      else if (catalogueStep === 3) setCatalogueStep(2);
      else if (catalogueStep === 4) setCatalogueStep(3);
      else if (catalogueStep === 5) setCatalogueStep(4);
      else if (catalogueStep === 6) setCatalogueStep(5);
      else if (catalogueStep === 7) setCatalogueStep(6);
    } else if (selectedDeliveryType === "one-time") {
      if (oneTimeStep === 1) setSelectedDeliveryType(null);
      else if (oneTimeStep === 2) setOneTimeStep(1);
      else if (oneTimeStep === 3) setOneTimeStep(2);
      else if (oneTimeStep === 4) setOneTimeStep(3);
      else if (oneTimeStep === 5) setOneTimeStep(4);
      else if (oneTimeStep === 6) setOneTimeStep(5);
    }
  };

  const handleSelectDelivery = (type) => {
    if (isTransitioning) return;

    // Clear any previous format message immediately and set selection
    setFormatSelectedMessage(null);
    setSelectedDeliveryType(type);
    setIsTransitioning(true);

    setTimeout(() => {
      // Preserve user's title/description and tone/style selections.
      // Keep some flow-specific defaults but advance each flow to the
      // step after Tone & Style (the Video Length step) so we don't
      // duplicate the Tone & Style UI which already appears on page 1.
      setSelectedFrequency(null);
      setCustomRecurrentDates([]); // Reset recurrent dates

      // RESET SERIES STATE but advance to configuration step (2)
      setSeriesStep(2);
      setNumberOfEpisodes(5);
      setSelectedReleaseSchedule(null);
      setCustomSeriesDates([]);

      // CATALOGUE: advance to configuration step (2)
      setCatalogueStep(2);
      setTargetVideos(10);
      setThemes("");

      // Do not clear tone/style or title/description — keep user input.
      setSelectedVideoLength(null);
      setCustomVideoLength("");
      setUploadedFiles([]);
      setReferenceLinks([]);
      setSelectedPrivacy(null);

      // Advance the flow-specific step so the next CTA goes to Length.
      // For one-time requests, skip the duplicated Tone/Style step (it's
      // already shown globally) and jump straight to the Video Length step.
      if (type === "one-time") setOneTimeStep(3);
      if (type === "recurrent") setRecurrentStep(1);
      if (type === "series") setSeriesStep(2);
      if (type === "catalogue") setCatalogueStep(2);

      // Immediately show a short confirmation message so users see feedback
      const immediateMap = {
        series: "Series selected — now configure episode details.",
        catalogue: "Catalogue selected — set target videos and themes.",
        recurrent: "Recurrent selected — choose a delivery frequency.",
        "one-time": "One-Time selected — next step: Tone & Style.",
      };
      try {
        setFormatSelectedMessage(immediateMap[type] || null);
      } catch (e) {}

      setIsTransitioning(false);
    }, 1000);
  };

  // Continue the pending submission after payment confirmation
  const continuePendingSubmission = (amount) => {
    if (!pendingSubmission) return;
    const finalAmount = typeof amount === "number" ? amount : paymentAmount;
    // Persist chosen payment as customPrice so previews reflect the paid amount
    setCustomPrice(finalAmount);

    const { flow, nextStep } = pendingSubmission;
    if (flow === "one-time") setOneTimeStep(nextStep);
    else if (flow === "series") setSeriesStep(nextStep);
    else if (flow === "recurrent") setRecurrentStep(nextStep);
    else if (flow === "catalogue") setCatalogueStep(nextStep);

    // Create a lightweight request object and publish it so other parts
    // of the app (for example `requests.jsx`) can pick it up immediately.
    try {
      const REQUESTS_KEY = "ideas_requests_v1";
      const newRequest = {
        id: `req_${Date.now()}`,
        title: title || "",
        description: description || "",
        delivery: flow,
        step: nextStep,
        amount: finalAmount,
        role: paymentRole,
        creator: selectedCreator
          ? { id: selectedCreator.id, name: selectedCreator.name }
          : null,
        createdAt: new Date().toISOString(),
        meta: {
          selectedTones: selectedTones || [],
          selectedVideoLength: selectedVideoLength || null,
          selectedPrivacy: selectedPrivacy || null,
        },
      };

      // Prepend to stored requests list
      try {
        const raw = window.localStorage.getItem(REQUESTS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        arr.unshift(newRequest);
        window.localStorage.setItem(REQUESTS_KEY, JSON.stringify(arr));
      } catch (e) {
        /* ignore storage errors */
      }

      // Broadcast a short-lived event so other windows/components can react immediately
      try {
        const ev = new CustomEvent("ideas:request_created", {
          detail: newRequest,
        });
        window.dispatchEvent(ev);
      } catch (e) {
        /* ignore */
      }
    } catch (e) {
      // ignore publishing errors
    }

    // Clear pending and close modal
    setPendingSubmission(null);
    setPaymentModalOpen(false);
  };

  // --- Title Animation Logic (Unchanged)
  useEffect(() => {
    let isMounted = true;
    let sweepStartTimeout, hideTitleTimeout, nextTitleChange;

    const cycle = () => {
      if (!isMounted) return;

      setTitleVisible(true);

      sweepStartTimeout = setTimeout(() => {
        setSweepActive(true);
      }, SWEEP_START_DELAY);

      hideTitleTimeout = setTimeout(() => {
        setSweepActive(false);
        setTitleVisible(false);
      }, SWEEP_START_DELAY + SWEEP_DURATION);

      nextTitleChange = setTimeout(() => {
        setCurrentTitleIndex((prevIndex) => (prevIndex + 1) % titles.length);
        cycle();
      }, SWEEP_START_DELAY + SWEEP_DURATION + FADE_DURATION);

      return () => {
        clearTimeout(sweepStartTimeout);
        clearTimeout(hideTitleTimeout);
        clearTimeout(nextTitleChange);
      };
    };

    cycle();

    return () => {
      isMounted = false;
    };
  }, [titles.length]);

  // --- Autosave / Restore Draft ---
  useEffect(() => {
    try {
      const saved = localStorage.getItem("ideas_draft_v1");
      if (saved) {
        const obj = JSON.parse(saved);
        if (obj.description) setDescription(obj.description);
        if (obj.title) setTitle(obj.title);
        // Intentionally do NOT auto-restore `selectedDeliveryType` to avoid
        // pre-selecting a format. The user should explicitly choose a format.
      }
    } catch (e) {
      // ignore
    }
    setIsDraftLoaded(true);
  }, []);

  useEffect(() => {
    if (!isDraftLoaded) return;
    try {
      const payload = {
        description,
        title,
        selectedDeliveryType,
        selectedTones,
        selectedVideoLength,
        selectedPrivacy,
      };
      localStorage.setItem("ideas_draft_v1", JSON.stringify(payload));
    } catch (e) {
      // ignore
    }
  }, [
    description,
    title,
    selectedDeliveryType,
    selectedTones,
    selectedVideoLength,
    selectedPrivacy,
    isDraftLoaded,
  ]);

  // Determine the current step status for the card
  let currentStatusText = isFormatSelected ? "1/1" : "0/1";

  if (isRecurrent) {
    currentStatusText = recurrentStep === 8 ? "7/7" : `${recurrentStep}/7`;
  } else if (isSeries) {
    currentStatusText = seriesStep === 8 ? "7/7" : `${seriesStep}/7`;
  } else if (isCatalogue) {
    currentStatusText = catalogueStep === 8 ? "7/7" : `${catalogueStep}/7`;
  } else if (selectedDeliveryType === "one-time") {
    currentStatusText = oneTimeStep === 7 ? "6/6" : `${oneTimeStep}/6`;
  }

  // Check if we are on the Tone Step, Length Step, or References Step to render special footer
  const isPremiumStep =
    (selectedDeliveryType === "one-time" &&
      (oneTimeStep === 2 || oneTimeStep === 3 || oneTimeStep === 4)) ||
    (isRecurrent &&
      (recurrentStep === 3 || recurrentStep === 4 || recurrentStep === 5)) ||
    (isSeries && (seriesStep === 3 || seriesStep === 4 || seriesStep === 5)) ||
    (isCatalogue &&
      (catalogueStep === 3 || catalogueStep === 4 || catalogueStep === 5));

  const isSuccessStep =
    (isSeries && seriesStep === 8) ||
    (isRecurrent && recurrentStep === 8) ||
    (isCatalogue && catalogueStep === 8) ||
    (selectedDeliveryType === "one-time" && oneTimeStep === 7);

  const getNextLabel = () => {
    if (isSeries) {
      if (seriesStep === 1) return "Continue to Number of Episodes";
      if (seriesStep === 2) return "Continue to Video Length";
      if (seriesStep === 3) return "Continue to Video Length";
      if (seriesStep === 4) return "Continue to References";
      if (seriesStep === 7) return "Submit Request";
      if (seriesStep === 8) return "Series Submitted!";
    }

    if (isCatalogue) {
      if (catalogueStep === 1) return "Continue to Configuration";
      if (catalogueStep === 2) return "Continue to Video Length";
      if (catalogueStep === 6) return "Review Request";
      if (catalogueStep === 7) return "Submit Request";
      if (catalogueStep === 8) return "Catalogue Submitted!";
    }

    if (isRecurrent) {
      if (recurrentStep === 1) return "Continue to Video Length";
      if (recurrentStep === 2) return "Continue to Video Length";
      if (recurrentStep === 6) return "Review Request";
      if (recurrentStep === 7) return "Submit Request";
    }

    if (selectedDeliveryType === "one-time") {
      if (oneTimeStep === 1) return "Continue to Video Length";
      if (oneTimeStep === 5) return "Review Request";
      if (oneTimeStep === 6) return "Submit Request";
    }

    if (!isFormatSelected) return "Next";
    return "Next";
  };

  return (
    <div className="min-h-screen flex flex-col app-container" style={{ backgroundColor: '#F8F8FA' }}>
      {/* Animations and helpers are defined in source; theme variables are global via ThemeProvider */}

      {/* Header: Progress Text and Visual Bar */}
      <header className="px-5 pt-4 sticky top-0 z-20" style={{ backgroundColor: '#F8F8FA', borderBottom: '1px solid rgba(15,23,42,0.03)' }}>
        <div className="flex justify-between items-center mb-2">
          <span className="text-sm text-gray-700 font-medium">Progress</span>
          <span className="text-sm font-normal" style={{ color: 'var(--color-accent)' }}>
            {progressPercentage.toFixed(0)}% complete
          </span>
        </div>
        {/* Visual Progress Bar */}
        <div
          className="h-2 bg-gray-200 rounded-full overflow-hidden w-full mb-6"
          style={{ marginTop: "10px" }}
        >
          <div
            className="h-full rounded-full transition-all duration-500"
            style={{
              width: `${progressPercentage}%`,
              background:
                "linear-gradient(90deg, rgba(var(--color-gold-rgb),0.18), rgba(var(--color-gold-rgb),0.06))",
              boxShadow: "0 0 3px rgba(var(--color-gold-rgb),0.12)",
            }}
          ></div>
        </div>
        <div className="text-xs text-gray-500 mt-1">Don't lose your progress — {progressPercentage.toFixed(0)}% complete</div>
      </header>

      <main className="ideas-root flex-grow px-5 pb-0 max-w-lg mx-auto w-full">
        {/* Main Heading Container (Animated Text) */}
        <div
          ref={titleBoxRef}
          className="mt-8 mb-5 rounded-xl text-center cream-glow-box"
          style={{
            padding: "18px 28px",
            background: `radial-gradient(ellipse at center, rgba(var(--color-gold-rgb,203,138,0),0.20) 0%, rgba(var(--color-gold-rgb,203,138,0),0.12) 18%, rgba(var(--color-gold-rgb,203,138,0),0.07) 36%, rgba(var(--color-gold-rgb,203,138,0),0.03) 60%, #F8F8FA 100%), linear-gradient(180deg, rgba(248,248,250,0.66), rgba(248,248,250,0.9))`,
            border: "1px solid rgba(var(--color-gold-rgb,203,138,0),0.12)",
            boxShadow: "inset 0 10px 30px rgba(255,255,255,0.6), inset 0 -8px 20px rgba(var(--color-gold-rgb,203,138,0),0.03), 0 6px 18px rgba(2,6,23,0.02)",
            WebkitBackdropFilter: "blur(4px)",
            backdropFilter: "blur(4px)"
          }}
        >
          <h1
            className={`
                            text-[26px] font-normal tracking-tighter leading-normal mx-auto max-w-fit 
                            sweeping-text-container 
                            transition-all ease-out
                            ${
                              titleVisible
                                ? "opacity-100 translate-y-0 duration-[500ms]"
                                : "opacity-0 translate-y-1 duration-[500ms]"
                            }
                        `}
            style={{
              color: `rgb(var(--color-gold-rgb,203,138,0))`,
              fontWeight: 300,
              fontSize: '30px',
              letterSpacing: '0',
              lineHeight: 1.1
            }}
          >
            {titles[currentTitleIndex]}
            {sweepActive && (
              <span className="sweep-effect" key={currentTitleIndex} />
            )}
          </h1>
        </div>

        {/* --- START: Time Estimate (hidden when request is complete) --- */}
        {!isSuccessStep && progressPercentage < 95 && (
          <div className="flex items-center justify-center mt-4 mb-8">
            <div
              className="inline-flex items-center rounded-xl px-4 py-2"
              style={{
                background: '#F6F6F8',
                border: '1px solid rgba(15,23,42,0.015)',
                boxShadow: 'inset 0 1px 0 rgba(255,255,255,0.6)',
                color: '#6B7280',
                width: titleBoxWidth ? `${titleBoxWidth}px` : 'auto',
                justifyContent: 'center',
                borderRadius: '12px',
                paddingLeft: '1.25rem',
                paddingRight: '1.25rem'
              }}
            >
              <Clock className="w-5 h-5 mr-3 text-gray-500" />
              <span className="text-base font-normal text-gray-600">
                {remainingSeconds >= 60
                  ? `About 1 minute left`
                  : `About ${remainingSeconds} second${
                      remainingSeconds === 1 ? "" : "s"
                    } left`}
              </span>
            </div>
          </div>
        )}
        {/* --- END: Time Estimate --- */}

        {/* --- START: Selection Status Card --- */}
        <div
          className="bg-gray-50 p-4 mb-8 border border-gray-200 rounded-xl flex justify-between items-center transition duration-200"
          style={{
            boxShadow:
              "0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0, 0, 0, 0.05)",
          }}
        >
          <div
            className={`w-6 h-6 rounded-full border-2 flex-shrink-0 flex items-center justify-center transition-all duration-300`}
            style={{
              borderColor: isFormatSelected
                ? "rgba(var(--color-gold-rgb, 203,138,0), 0.20)"
                : "rgb(156 163 175)",
              backgroundColor: isFormatSelected
                ? "rgba(var(--color-gold-rgb, 203,138,0), 0.10)"
                : "transparent",
            }}
          >
            {isFormatSelected && (
              <Check className="w-4 h-4 text-[var(--color-gold)]" strokeWidth={3} />
            )}
          </div>
          <span
            className="text-sm font-medium ml-auto"
            style={{
              color: isFormatSelected
                ? "var(--color-gold-light)"
                : "rgb(156 163 175)",
            }}
          >
            {currentStatusText}
          </span>
        </div>
        {/* --- END: Selection Status Card --- */}

        {/* --- DESCRIPTION & TITLE (now collected before format selection) --- */}
        <div className="space-y-4 mb-6">
          <label htmlFor="description-input" className="sr-only">
            Description <span className="sr-only">*</span>
          </label>
          <div className="relative">
            <textarea
              id="description-input"
              rows="6"
              placeholder="Describe what you'd love to see in this video."
              value={description}
              onChange={(e) => setDescription(e.target.value.slice(0, MAX_CHARS))}
              className="w-full p-5 text-gray-700 border border-gray-200 rounded-xl focus:ring-0 focus:border-gray-300 transition duration-150 resize-none outline-none text-base"
              style={{ boxShadow: "0 1px 3px 0 rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.05)" }}
            ></textarea>
            <span className="absolute bottom-4 right-4 text-xs text-gray-400 font-medium">
              {description.length}/{MAX_CHARS} char
            </span>
          </div>

          {description.length >= MIN_CHARS && (
            <div className="animate-in fade-in slide-in-from-bottom-2 duration-500">
              <label htmlFor="title-input" className="text-gray-800 font-semibold text-base block tracking-tight">
                Give a title to your video <span className="text-red-500">*</span>
              </label>
              <input
                id="title-input"
                type="text"
                placeholder="Enter a title..."
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                className="w-full p-4 mt-2 text-gray-700 border border-gray-200 rounded-xl focus:ring-0 focus:border-gray-300 transition duration-150 outline-none text-base"
                style={{ boxShadow: "0 1px 3px 0 rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.05)" }}
              />
            </div>
          )}
        </div>

        {/* --- Tone & Style Selection (progressive reveal after title) --- */}
        {title && title.length >= MIN_TITLE_CHARS && (
          <div className="mb-6">
            <ToneStyleStep
              selectedTones={selectedTones}
              setSelectedTones={setSelectedTones}
              selectedStyles={selectedStyles}
              setSelectedStyles={setSelectedStyles}
            />
          </div>
        )}

        {title && title.length >= MIN_TITLE_CHARS && showFormatSection && (
          <>
            {/* --- Main Question (moved above Examples box) */}
            <div className="mb-4 mt-6">
              <h2 className="text-gray-800 font-semibold text-base block tracking-tight">
                Preferred delivery?
              </h2>
            </div>

            {/* --- Examples Box (appears after a short delay) --- */}
            {showExamples && (
              <div
                className="mb-8 rounded-xl cream-glow-box stagger-animate"
                style={{ padding: "20px", background: "radial-gradient(circle at 18% 20%, rgba(var(--color-gold-rgb,203,138,0),0.10), rgba(var(--color-gold-rgb,203,138,0),0.03) 28%, var(--color-cream-bg) 60%), var(--color-cream-bg)", border: "1px solid rgba(var(--color-gold-rgb,203,138,0),0.12)", boxShadow: "inset 0 6px 12px rgba(var(--color-gold-rgb,203,138,0),0.03)" }}
              >
              <div className="flex items-center mb-4">
                <span className="p-1 rounded-full mr-2 text-[var(--color-gold)]" style={{background: 'linear-gradient(135deg, rgba(var(--color-gold-rgb,203,138,0),0.12), rgba(var(--color-gold-rgb,203,138,0),0.04))', boxShadow: 'inset 0 2px 6px rgba(var(--color-gold-rgb,203,138,0),0.05)'}}>
                  <Lightbulb className="w-6 h-6 text-[var(--color-gold)]" />
                </span>
                <h3 className="text-base font-semibold text-gray-700">
                  Examples to help you choose:
                </h3>
              </div>
              {/* List of Examples */}
              <ul className="list-none space-y-3 pl-0 text-sm text-gray-700">
                <li>
                  <strong className="text-gray-900">One-Time:</strong>{" "}
                  "Explain quantum computing," "Review the new iPhone," "My morning routine"
                </li>
                <li>
                  <strong className="text-gray-900">Recurrent:</strong>{" "}
                  "Daily market updates," "Weekly cooking tips," "Monthly tech news roundup"
                </li>
                <li>
                  <strong className="text-gray-900">Series:</strong>{" "}
                  "5-part history of Rome," "Learn Spanish in 10 episodes," "Startup journey series"
                </li>
                <li>
                  <strong className="text-gray-900">Catalogue:</strong>{" "}
                  "50 productivity hacks," "Travel guides for 20 cities," "Complete guitar tutorial library"
                </li>
              </ul>
            </div>
            )}

            {/* --- START: Delivery Type Dropdown (compact with icons) --- */}
            <div className="mb-8">
              <div className="relative">
                <button
                  type="button"
                  onClick={() => setDeliveryDropdownOpen((s) => !s)}
                  className="w-full flex items-center justify-between p-4 bg-[var(--surface)] border border-gray-200 rounded-xl shadow-sm"
                  aria-haspopup="listbox"
                  aria-expanded={deliveryDropdownOpen}
                >
                  <div className="flex items-center">
                    {selectedDeliveryType ? (
                      (() => {
                        const opt = deliveryOptions.find((o) => o.type === selectedDeliveryType);
                        return (
                          <>
                            <opt.Icon className="w-5 h-5 mr-3 text-gray-400" />
                            <div className="text-sm font-medium text-gray-800">{opt.title}</div>
                          </>
                        );
                      })()
                    ) : (
                      <div className="text-sm text-gray-500">Select the format you want</div>
                    )}
                  </div>
                  <svg className="w-4 h-4 text-gray-500" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 8L10 12L14 8" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                  </svg>
                </button>

                {deliveryDropdownOpen && (
                  <div className="absolute z-20 mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-lg">
                    <ul ref={deliveryListRef} role="listbox" aria-label="Delivery formats" className="divide-y divide-gray-100">
                      {deliveryOptions.map((option) => (
                        <li
                          key={option.type}
                          role="option"
                          tabIndex={0}
                          aria-selected={selectedDeliveryType === option.type}
                          onClick={() => { handleSelectDelivery(option.type); setDeliveryDropdownOpen(false); }}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                              e.preventDefault();
                              handleSelectDelivery(option.type);
                              setDeliveryDropdownOpen(false);
                            }
                          }}
                          className="flex items-center p-3 hover:bg-gray-50 cursor-pointer"
                        >
                          <option.Icon className={`w-5 h-5 mr-3 ${selectedDeliveryType === option.type ? 'text-[var(--color-accent)]' : 'text-gray-400'}`} />
                          <div className="flex-1">
                            <div className="text-sm font-medium text-gray-800">{option.title}</div>
                            <div className="text-xs text-gray-500">{option.subtitle}</div>
                          </div>
                          {selectedDeliveryType === option.type && (
                            <Check className="w-4 h-4 text-[var(--color-accent)]" />
                          )}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </div>
            {/* --- END: Delivery Type Selection Cards --- */}
          </>
        )}
        {title && title.length >= MIN_TITLE_CHARS && (
          /* --- Dynamic Form Content based on Selection --- */

          selectedDeliveryType === "one-time" && !isTransitioning ? (
            /* SHOW ONE-TIME VIDEO DETAILS */
            oneTimeStep === 1 ? (
              <OneTimeVideoDetails
                description={description}
                setDescription={setDescription}
                title={title}
                setTitle={setTitle}
                MAX_CHARS={MAX_CHARS}
              />
            ) : oneTimeStep === 2 ? (
              <ToneStyleStep
                selectedTones={selectedTones}
                setSelectedTones={setSelectedTones}
                selectedStyles={selectedStyles}
                setSelectedStyles={setSelectedStyles}
              />
            ) : oneTimeStep === 3 ? (
              <VideoLengthStep
                selectedLength={selectedVideoLength}
                setSelectedLength={setSelectedVideoLength}
                customLength={customVideoLength}
                setCustomLength={setCustomVideoLength}
              />
            ) : oneTimeStep === 4 ? (
              <ReferencesStep
                files={uploadedFiles}
                setFiles={setUploadedFiles}
                links={referenceLinks}
                setLinks={setReferenceLinks}
              />
            ) : oneTimeStep === 5 ? (
              <PrivacySettingsStep
                selectedPrivacy={selectedPrivacy}
                setSelectedPrivacy={setSelectedPrivacy}
                prevStepCompleted={true}
              />
            ) : oneTimeStep === 6 ? (
              <ReviewRequestStep
                title={title}
                description={description}
                selectedDeliveryType={selectedDeliveryType}
                selectedTones={selectedTones}
                selectedVideoLength={selectedVideoLength}
                customVideoLength={customVideoLength}
                uploadedFiles={uploadedFiles}
                referenceLinks={referenceLinks}
                selectedPrivacy={selectedPrivacy}
                customPrice={customPrice}
                setCustomPrice={setCustomPrice}
                editingPrice={editingPrice}
                setEditingPrice={setEditingPrice}
                priceInput={priceInput}
                setPriceInput={setPriceInput}
                priceInputRef={priceInputRef}
                savePrice={savePrice}
                displayPrice={displayPrice}
                sanitizePriceInput={sanitizePriceInput}
                onEdit={() => setOneTimeStep(1)}
              />
            ) : (
              <SponsorConfirmation />
            )
          ) : selectedDeliveryType === "recurrent" && !isTransitioning ? (
            /* SHOW RECURRENT VIDEO DETAILS (New multi-step flow) */
            recurrentStep === 3 ? (
              title && title.length >= MIN_TITLE_CHARS ? (
                <VideoLengthStep
                  selectedLength={selectedVideoLength}
                  setSelectedLength={setSelectedVideoLength}
                  customLength={customVideoLength}
                  setCustomLength={setCustomVideoLength}
                />
              ) : (
                <ToneStyleStep
                  selectedTones={selectedTones}
                  setSelectedTones={setSelectedTones}
                  selectedStyles={selectedStyles}
                  setSelectedStyles={setSelectedStyles}
                />
              )
            ) : recurrentStep === 4 ? (
              <VideoLengthStep
                selectedLength={selectedVideoLength}
                setSelectedLength={setSelectedVideoLength}
                customLength={customVideoLength}
                setCustomLength={setCustomVideoLength}
              />
            ) : recurrentStep === 5 ? (
              <ReferencesStep
                files={uploadedFiles}
                setFiles={setUploadedFiles}
                links={referenceLinks}
                setLinks={setReferenceLinks}
              />
            ) : recurrentStep === 6 ? (
              <PrivacySettingsStep
                selectedPrivacy={selectedPrivacy}
                setSelectedPrivacy={setSelectedPrivacy}
                prevStepCompleted={true}
              />
            ) : recurrentStep === 7 ? (
              <ReviewRequestStep
                title={title}
                description={description}
                selectedDeliveryType={selectedDeliveryType}
                selectedFrequency={selectedFrequency}
                customRecurrentDates={customRecurrentDates}
                selectedTones={selectedTones}
                selectedVideoLength={selectedVideoLength}
                customVideoLength={customVideoLength}
                uploadedFiles={uploadedFiles}
                referenceLinks={referenceLinks}
                selectedPrivacy={selectedPrivacy}
                customPrice={customPrice}
                setCustomPrice={setCustomPrice}
                editingPrice={editingPrice}
                setEditingPrice={setEditingPrice}
                priceInput={priceInput}
                setPriceInput={setPriceInput}
                priceInputRef={priceInputRef}
                savePrice={savePrice}
                displayPrice={displayPrice}
                sanitizePriceInput={sanitizePriceInput}
                onEdit={() => setRecurrentStep(1)}
              />
            ) : (
              <RecurrentVideoDetails
                description={description}
                setDescription={setDescription}
                title={title}
                setTitle={setTitle}
                MAX_CHARS={MAX_CHARS}
                MIN_CHARS={MIN_CHARS}
                recurrentStep={recurrentStep}
                selectedFrequency={selectedFrequency}
                setSelectedFrequency={setSelectedFrequency}
                selectedTones={selectedTones}
                setSelectedTones={setSelectedTones}
                customRecurrentDates={customRecurrentDates}
                setCustomRecurrentDates={setCustomRecurrentDates}
              />
            )
          ) : selectedDeliveryType === "series" && !isTransitioning ? (
            /* SHOW SERIES VIDEO DETAILS (New multi-step flow) */
            seriesStep === 3 ? (
              title && title.length >= MIN_TITLE_CHARS ? (
                <VideoLengthStep
                  selectedLength={selectedVideoLength}
                  setSelectedLength={setSelectedVideoLength}
                  customLength={customVideoLength}
                  setCustomLength={setCustomVideoLength}
                />
              ) : (
                <ToneStyleStep
                  selectedTones={selectedTones}
                  setSelectedTones={setSelectedTones}
                  selectedStyles={selectedStyles}
                  setSelectedStyles={setSelectedStyles}
                />
              )
            ) : seriesStep === 4 ? (
              <VideoLengthStep
                selectedLength={selectedVideoLength}
                setSelectedLength={setSelectedVideoLength}
                customLength={customVideoLength}
                setCustomLength={setCustomVideoLength}
              />
            ) : seriesStep === 5 ? (
              <ReferencesStep
                files={uploadedFiles}
                setFiles={setUploadedFiles}
                links={referenceLinks}
                setLinks={setReferenceLinks}
              />
            ) : seriesStep === 6 ? (
              <PrivacySettingsStep
                selectedPrivacy={selectedPrivacy}
                setSelectedPrivacy={setSelectedPrivacy}
                prevStepCompleted={true}
              />
            ) : seriesStep === 7 ? (
              <ReviewRequestStep
                title={title}
                description={description}
                selectedDeliveryType={selectedDeliveryType}
                numberOfEpisodes={numberOfEpisodes}
                selectedReleaseSchedule={selectedReleaseSchedule}
                customSeriesDates={customSeriesDates}
                selectedTones={selectedTones}
                selectedVideoLength={selectedVideoLength}
                customVideoLength={customVideoLength}
                uploadedFiles={uploadedFiles}
                referenceLinks={referenceLinks}
                selectedPrivacy={selectedPrivacy}
                customPrice={customPrice}
                setCustomPrice={setCustomPrice}
                editingPrice={editingPrice}
                setEditingPrice={setEditingPrice}
                priceInput={priceInput}
                setPriceInput={setPriceInput}
                priceInputRef={priceInputRef}
                savePrice={savePrice}
                displayPrice={displayPrice}
                sanitizePriceInput={sanitizePriceInput}
                onEdit={() => setSeriesStep(1)}
              />
            ) : (
              <SeriesVideoDetails
                description={description}
                setDescription={setDescription}
                title={title}
                setTitle={setTitle}
                MAX_CHARS={MAX_CHARS}
                seriesStep={seriesStep}
                numberOfEpisodes={numberOfEpisodes}
                setNumberOfEpisodes={setNumberOfEpisodes}
                selectedReleaseSchedule={selectedReleaseSchedule}
                setSelectedReleaseSchedule={setSelectedReleaseSchedule}
                selectedTones={selectedTones}
                setSelectedTones={setSelectedTones}
                customSeriesDates={customSeriesDates}
                setCustomSeriesDates={setCustomSeriesDates}
                selectedPrivacy={selectedPrivacy}
                setSelectedPrivacy={setSelectedPrivacy}
              />
            )
            ) : selectedDeliveryType === "catalogue" && !isTransitioning ? ( // NEW CATALOGUE RENDER
            /* SHOW CATALOGUE VIDEO DETAILS (New multi-step flow) */
            catalogueStep === 3 ? (
              title && title.length >= MIN_TITLE_CHARS ? (
                <VideoLengthStep
                  selectedLength={selectedVideoLength}
                  setSelectedLength={setSelectedVideoLength}
                  customLength={customVideoLength}
                  setCustomLength={setCustomVideoLength}
                />
              ) : (
                <ToneStyleStep
                  selectedTones={selectedTones}
                  setSelectedTones={setSelectedTones}
                  selectedStyles={selectedStyles}
                  setSelectedStyles={setSelectedStyles}
                />
              )
            ) : catalogueStep === 4 ? (
              <VideoLengthStep
                selectedLength={selectedVideoLength}
                setSelectedLength={setSelectedVideoLength}
                customLength={customVideoLength}
                setCustomLength={setCustomVideoLength}
              />
            ) : catalogueStep === 5 ? (
              <ReferencesStep
                files={uploadedFiles}
                setFiles={setUploadedFiles}
                links={referenceLinks}
                setLinks={setReferenceLinks}
              />
            ) : catalogueStep === 6 ? (
              <PrivacySettingsStep
                selectedPrivacy={selectedPrivacy}
                setSelectedPrivacy={setSelectedPrivacy}
                prevStepCompleted={true}
              />
            ) : catalogueStep === 7 ? (
              <ReviewRequestStep
                title={title}
                description={description}
                selectedDeliveryType={selectedDeliveryType}
                targetVideos={targetVideos}
                themes={themes}
                selectedTones={selectedTones}
                selectedVideoLength={selectedVideoLength}
                customVideoLength={customVideoLength}
                uploadedFiles={uploadedFiles}
                referenceLinks={referenceLinks}
                selectedPrivacy={selectedPrivacy}
                customPrice={customPrice}
                setCustomPrice={setCustomPrice}
                editingPrice={editingPrice}
                setEditingPrice={setEditingPrice}
                priceInput={priceInput}
                setPriceInput={setPriceInput}
                priceInputRef={priceInputRef}
                savePrice={savePrice}
                displayPrice={displayPrice}
                sanitizePriceInput={sanitizePriceInput}
                onEdit={() => setCatalogueStep(1)}
              />
            ) : (
              <CatalogueVideoDetails
                description={description}
                setDescription={setDescription}
                title={title}
                setTitle={setTitle}
                MAX_CHARS={MAX_CHARS}
                MIN_CHARS={MIN_CHARS}
                catalogueStep={catalogueStep}
                targetVideos={targetVideos}
                setTargetVideos={setTargetVideos}
                themes={themes}
                setThemes={setThemes}
                selectedTones={selectedTones}
                setSelectedTones={setSelectedTones}
                selectedPrivacy={selectedPrivacy}
                setSelectedPrivacy={setSelectedPrivacy}
              />
            )
          ) : (
            /* SHOW INITIAL PROMPT & SELECTION CARDS */
            <>
              {/* Generic Text Input (Hidden if selection is made, shown as initial prompt) */}
              <div className="relative mb-8 mt-0">
                <textarea
                  rows="4"
                  placeholder={`What do you want creators to make (Min ${MIN_CHARS} characters, e.g., "A single video on...")`}
                  value={description}
                  onChange={(e) =>
                    setDescription(e.target.value.slice(0, MAX_CHARS))
                  }
                  onBlur={() => setTouchedDescription(true)}
                  className="w-full p-5 text-gray-700 border border-gray-200 rounded-xl focus:ring-0 focus:border-gray-300 transition duration-150 resize-none outline-none text-base"
                  style={{
                    boxShadow:
                      "0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0, 0, 0, 0.05)",
                  }}
                ></textarea>
                <span className="absolute bottom-4 right-4 text-xs text-gray-400 font-medium">
                  {description.length}/{MAX_CHARS} char
                </span>
                {touchedDescription && description.length < MIN_CHARS && (
                  <p className="mt-2 text-xs text-red-500">
                    Please enter at least {MIN_CHARS} characters to continue.
                  </p>
                )}
              </div>

              {/* Progressive Disclosure: Only show options if description meets min length */}
              {description.length >= MIN_CHARS && (
                <div>
                  {/* Examples moved above to appear before delivery options */}
                </div>
              )}
            </>
          )
        )}
      </main>

      {/* Action Bar/Footer Separator and Button */}
      <div className="w-full max-w-lg mx-auto px-5 z-10 pb-28 mt-auto" style={{ backgroundColor: '#F8F8FA' }}>
        <div className="border-t border-gray-200 w-full" />

        <div className="w-full py-6">
          {isPremiumStep ? (
            <div className="flex flex-col space-y-3">
              <button
                onClick={handleNext}
                className="w-full h-12 rounded-xl flex items-center justify-center space-x-2 text-[15px] font-medium text-white shadow-sm hover:opacity-90 transition duration-200"
                style={{
                  backgroundColor: ACTIVE_BG_COLOR,
                  boxShadow: ACTIVE_SHADOW,
                }}
              >
                <span>Upgrade to Continue</span>
                <Crown className="w-4 h-4" />
              </button>
              <button
                onClick={handleNext}
                className="w-full h-12 rounded-xl flex items-center justify-center text-[15px] font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 transition duration-200"
              >
                Skip
              </button>
            </div>
          ) : (
            <div className="flex flex-col space-y-3">
              <button
                onClick={handleNext}
                disabled={!isNextEnabled}
                className={`
                                    w-full h-12 rounded-xl flex items-center justify-center space-x-2
                                    text-[15px] font-medium transition-all duration-200
                                    ${
                                      !isNextEnabled
                                        ? "bg-gray-100 text-gray-400 opacity-70 cursor-not-allowed"
                                        : "text-white hover:opacity-95 active:scale-[0.98]"
                                    }
                                    ${isAnimating ? "scale-[1.01]" : ""} 
                                `}
                style={
                  isNextEnabled
                    ? {
                        backgroundColor: ACTIVE_BG_COLOR,
                        boxShadow: "0 4px 12px rgba(6,24,58,0.16)", // Softer, more spread out navy shadow
                        color: "white",
                      }
                    : {}
                }
              >
                <span className="p-1 rounded-full mr-2 text-gold-small">{getNextLabel()}</span>
                {/* Hide the arrow on the final success step */}
                {!(isSeries && seriesStep === 8) &&
                  !(isCatalogue && catalogueStep === 8) &&
                  !(isRecurrent && recurrentStep === 8) &&
                  !(
                    selectedDeliveryType === "one-time" && oneTimeStep === 7
                  ) && <ArrowRight className="w-4 h-4" />}
              </button>

              {isFormatSelected && !isSuccessStep && (
                <button
                  onClick={handleBack}
                  className="w-full h-12 rounded-xl flex items-center justify-center text-[15px] font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 transition duration-200"
                >
                  Back
                </button>
              )}
            </div>
          )}
        </div>
         </div>

            {/* --- Post-selection message and examples for chosen format --- */}
            {formatSelectedMessage && (
              <div className="mt-3 flex items-center text-sm font-normal text-[var(--color-accent)] animate-in fade-in">
                <Check className="w-4 h-4 mr-2 text-[var(--color-accent)]" />
                <span>{formatSelectedMessage}</span>
              </div>
            )}

            {/* Per-format examples removed — keep only the top 'Examples to help you choose:' block */}

            {/* Shared edit row for any selected format */}
            {selectedDeliveryType && (
              <div className="mt-4 flex items-center justify-between text-sm text-gray-600">
                <span className="italic">Using the Description and Title you entered above for this request.</span>
                <button
                  type="button"
                  className="ml-4 text-sm font-medium text-[var(--color-accent)] hover:underline"
                  onClick={() => {
                    const el = document.getElementById("description-input");
                    if (el) {
                      el.scrollIntoView({ behavior: "smooth", block: "center" });
                      el.focus();
                      el.classList.add("jump-highlight");
                      setTimeout(() => el.classList.remove("jump-highlight"), 900);
                    }
                    const titleEl = document.getElementById("title-input");
                    if (titleEl) {
                      setTimeout(() => {
                        titleEl.focus();
                        titleEl.classList.add("jump-highlight");
                        setTimeout(() => titleEl.classList.remove("jump-highlight"), 900);
                      }, 300);
                    }
                  }}
                >
                  Edit
                </button>
              </div>
            )}
      {/* Floating See Preview button (fixed) */}
      <button
        onClick={() => setPreviewModalOpen((s) => !s)}
        className={`fixed right-5 bottom-36 px-4 py-2 rounded-full shadow-lg text-sm font-normal flex items-center space-x-2 ${previewModalOpen ? 'bg-[var(--color-gold)] text-white z-60' : 'bg-[var(--surface)] text-gray-800 border border-gray-100'}`}
        style={previewModalOpen ? { border: '1px solid rgba(var(--color-gold-rgb,203,138,0),0.22)' } : {}}
        aria-label={previewModalOpen ? 'Close preview' : 'See preview'}
      >
        <span>{previewModalOpen ? 'Close preview' : 'See preview'}</span>
      </button>

      {/* debug badge removed */}

      {/* Preview Modal (dim background + centered preview card) */}
      {previewModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black opacity-40"
            onClick={() => setPreviewModalOpen(false)}
          />

          <div className="relative z-50 w-full max-w-2xl mx-auto px-6">
            <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-2xl">
              <div className="flex justify-between items-start mb-4">
                <h3 className="text-base font-semibold text-gray-900">Preview</h3>
                <button
                  onClick={() => setPreviewModalOpen(false)}
                  className="text-gray-400 hover:text-gray-700 p-1"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              {/* Reuse preview layout (mirrors in-page preview). Add paddingRight to keep content clear of CLAIM tab */}
              <div className="relative mb-2 overflow-visible">
                <div
                  className="bg-white p-5 pb-4 rounded-3xl border border-gray-50 relative z-10 preview-card"
                  style={{ paddingRight: "72px" }}
                >
                  <div
                    style={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      right: 0,
                      height: 0,
                    }}
                  />
                  <div
                    style={{
                      position: "absolute",
                      top: 0,
                      right: 0,
                      width: "180px",
                      height: "180px",
                      borderRadius: "0 16px 0 0",
                      overflow: "hidden",
                      background:
                        "radial-gradient(circle at 100% 0%, rgba(243,244,246,0.9) 0%, rgba(243,244,246,0.6) 70%, transparent 100%)",
                      zIndex: 0,
                      pointerEvents: "none",
                    }}
                    aria-hidden="true"
                  />

                  <button
                    style={{
                      position: "absolute",
                      top: "50%",
                      right: "-12px",
                      transform: "translateY(-50%) rotate(-90deg)",
                      backgroundColor: getCssVar('--bg', '#f3f4f6'),
                      color: getCssVar('--muted', '#6b7280'),
                      fontSize: 11,
                      fontWeight: 700,
                      padding: "5px 12px",
                      borderRadius: 6,
                      border: "none",
                      boxShadow: "none",
                    }}
                    disabled
                  >
                    CLAIM
                  </button>

                  <div className="absolute top-4 right-4 flex flex-col items-end space-y-1 z-10">
                    <div
                      style={{
                        backgroundColor: "var(--brand-gold)",
                        color: "white",
                        fontWeight: 700,
                        padding: "6px 10px",
                        borderRadius: "0 10px 0 10px",
                        fontSize: 13,
                      }}
                    >
                      {editingPrice ? (
                        <form
                          onSubmit={(e) => {
                            e.preventDefault();
                            savePrice();
                          }}
                        >
                          <input
                            ref={priceInputRef}
                            type="text"
                            inputMode="decimal"
                            pattern="^\d*(\.\d{0,2})?$"
                            value={priceInput}
                            onChange={(e) =>
                              setPriceInput(sanitizePriceInput(e.target.value))
                            }
                            onKeyDown={(e) => {
                              if (e.key === "Enter") {
                                e.preventDefault();
                                savePrice();
                              }
                            }}
                            onBlur={() => savePrice()}
                            className="text-right"
                            style={{
                              background: "transparent",
                              color: "white",
                              border: "none",
                              outline: "none",
                              width: "64px",
                              fontWeight: 700,
                            }}
                          />
                        </form>
                      ) : (
                        <button
                          onClick={() => {
                            setPriceInput((displayPrice || 0).toFixed(2));
                            setEditingPrice(true);
                          }}
                          style={{
                            background: "transparent",
                            color: "inherit",
                            border: "none",
                            padding: 0,
                          }}
                        >
                          {"$" + (displayPrice || 0).toFixed(2)}
                        </button>
                      )}
                    </div>
                  </div>

                  <div className="absolute top-4 left-4 z-10">
                    <div className="bg-gray-800 text-white text-xs font-bold px-3 py-1 rounded-full">
                      RANK #
                    </div>
                  </div>

                  <div className="flex items-start mb-4 relative z-10 pt-6">
                    <div className="flex items-center">
                      <div className="w-10 h-10 rounded-full overflow-hidden mr-3 flex-shrink-0 relative bg-gray-100 flex items-center justify-center text-lg font-bold text-gray-700">
                        Y
                      </div>
                      <div>
                        <p className="text-xs font-normal text-gray-800">
                          You
                        </p>
                        <p className="text-xs text-gray-600">Just now</p>
                      </div>
                    </div>
                  </div>

                  <h2
                    className="text-lg font-extrabold text-gray-900 mb-2 leading-tight"
                    style={{
                      overflowWrap: "anywhere",
                      wordBreak: "break-word",
                    }}
                  >
                    {title || ""}
                  </h2>
                  <p className="text-sm text-gray-800 mb-2 break-words">
                    {description || ""}
                  </p>

                  <div className="border-t border-gray-100 pt-3 flex justify-between items-center">
                    <div className="flex space-x-4 text-gray-600">
                      <div className="flex items-center space-x-2 text-gray-500">
                        <Heart className="w-5 h-5" />
                        <span className="text-xs">0</span>
                      </div>
                      <div className="flex items-center space-x-2 text-gray-500">
                        <MessageSquare className="w-5 h-5" />
                        <span className="text-xs">
                          {referenceLinks?.length || 0}
                        </span>
                      </div>
                      <div className="flex items-center space-x-2 text-gray-500">
                        <ChevronsUp className="w-5 h-5" />
                        <span className="text-xs">0 Boosts</span>
                      </div>
                    </div>

                    <div className="flex space-x-2 preview-footer-icons">
                      <div className="p-2.5 rounded-full bg-[var(--surface)] hover:bg-[var(--bg)] transition-colors ring-1 ring-gray-200">
                        <Bookmark className="w-5 h-5 text-gray-500" />
                      </div>
                      <div className="p-2.5 rounded-full bg-[var(--surface)] hover:bg-[var(--bg)] transition-colors ring-1 ring-gray-200">
                        <Lightbulb className="w-5 h-5 text-gray-500" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Payment Modal (appears before final submission) */}
      {paymentModalOpen && (
        <div
          className="fixed inset-0 flex items-center justify-center"
          style={{ zIndex: 9999 }}
        >
          <div
            onClick={() => {
              setPaymentModalOpen(false);
              setPendingSubmission(null);
            }}
            style={{
              position: "absolute",
              inset: 0,
              backgroundColor: "rgba(0,0,0,0.6)",
              zIndex: 9999,
            }}
          />

          <div
            className="relative w-full max-w-2xl mx-auto px-6"
            style={{ zIndex: 10000 }}
          >
            <div className="bg-[var(--surface)] p-8 rounded-2xl border border-gray-100 shadow-2xl">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h3 className="text-base font-semibold text-gray-900">
                    Complete Payment
                  </h3>
                  <p className="text-sm text-gray-500">
                    Minimum per request is <strong>$15.00</strong>. Choose a
                    preset or set a custom amount.
                  </p>
                </div>
                <button
                  onClick={() => {
                    setPaymentModalOpen(false);
                    setPendingSubmission(null);
                  }}
                  className="text-gray-400 hover:text-gray-700 p-1"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="grid grid-cols-1 gap-6">
                {/* Preset Buttons */}
                <div className="flex gap-3 flex-wrap items-center">
                  {PAYMENT_PRESETS.map((p) => (
                    <button
                      key={p}
                      onClick={() => {
                        setPaymentAmount(p);
                        trackEvent("preset_selected", { preset: p });
                      }}
                      className={`preset-btn px-5 py-3 rounded-2xl font-semibold relative ${
                        paymentAmount === p
                          ? "bg-primary text-white"
                          : "bg-gray-50 text-gray-700 border border-gray-100"
                      }`}
                      style={
                        paymentAmount === p
                          ? {
                              backgroundColor: "var(--color-primary)",
                              color: "white",
                            }
                          : {}
                      }
                    >
                      {"$" + p}
                      {p === 25 && (
                        <span className="most-popular-badge" aria-hidden="true">
                          Most popular
                        </span>
                      )}
                    </button>
                  ))}
                  <div className="ml-auto text-sm text-gray-500 self-center">
                    Or set a custom amount
                  </div>
                </div>

                {/* Slider + input */}
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <label className="text-sm font-medium text-gray-700">
                      Amount
                    </label>
                    <div className="text-lg font-bold text-gray-900">
                      {"$" +
                        Number(paymentAmount).toLocaleString(undefined, {
                          minimumFractionDigits: 2,
                          maximumFractionDigits: 2,
                        })}
                    </div>
                  </div>
                  <input
                    type="range"
                    min={15}
                    max={5000}
                    step={1}
                    value={paymentAmount}
                    onChange={(e) => {
                      setPaymentAmount(Number(e.target.value));
                      trackEvent("slider_changed", {
                        amount: Number(e.target.value),
                      });
                    }}
                    className="w-full"
                  />

                  <div className="flex items-center space-x-3">
                    <input
                      type="number"
                      min={15}
                      value={paymentAmount}
                      onChange={(e) => {
                        const v = Math.max(15, Number(e.target.value || 0));
                        setPaymentAmount(v);
                        trackEvent("custom_amount_input", { amount: v });
                      }}
                      className="p-2 border border-gray-200 rounded-lg w-40"
                    />
                    <div className="text-xs text-gray-500">Min $15.00</div>
                  </div>
                </div>

                {/* Role selection */}
                <div>
                  <div className="text-sm font-medium text-gray-700 mb-2">
                    Choose provider level
                  </div>
                  <div className="provider-carousel-wrap">
                    <div className="provider-carousel">
                      {/* Creator Card */}
                      <div
                        className={"provider-card " + (paymentRole === "creator" && !selectedCreator ? "selected" : "")}
                        onClick={() => {
                          setPaymentRole("creator");
                          trackEvent("role_selected", { role: "creator" });
                        }}
                      >
                        <div>
                          <div className="card-title">Creator</div>
                          <div className="card-sub">Standard professionals</div>
                        </div>
                        <div className="text-sm text-gray-600">
                          Reliable, cost-effective creators
                        </div>
                      </div>

                      {/* Expert Card */}
                      <div
                        className={"provider-card " + (paymentRole === "expert" ? "selected" : "")}
                        onClick={() => {
                          setPaymentRole("expert");
                          trackEvent("role_selected", { role: "expert" });
                        }}
                      >
                        <div>
                          <div className="card-title">Expert</div>
                          <div className="card-sub">Top-tier creators</div>
                        </div>
                        <div className="text-sm text-[var(--color-gold)] font-bold">
                          +30% premium
                        </div>
                      </div>

                      {/* Choose Creator Card (expandable) */}
                      <div
                        className={"provider-card " + (selectedCreator ? "selected" : "") + (chooseCreatorExpanded ? " expanded" : "")}
                        onClick={() => {
                          // Toggle expansion when tapping the header/card (but clicking inside input should not re-toggle)
                          setChooseCreatorExpanded((prev) => !prev);
                          setPaymentRole("creator");
                        }}
                        role="button"
                        tabIndex={0}
                        onKeyDown={(e) => {
                          if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            setChooseCreatorExpanded((prev) => !prev);
                          }
                        }}
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <div className="card-title">Choose Creator</div>
                            <div className="card-sub">
                              {selectedCreator ? (
                                <span className="creator-selected-pill">
                                  {selectedCreator.name} selected
                                </span>
                              ) : (
                                "Search by @username"
                              )}
                            </div>
                          </div>
                          <div className="text-xs text-gray-400">
                            {chooseCreatorExpanded ? "Close" : "Pick"}
                          </div>
                        </div>

                        {/* Expanded content (search + results) — stop propagation of clicks inside to avoid collapsing */}
                        {chooseCreatorExpanded && (
                          <div
                            className="mt-3 expanded-body"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <div style={{ position: "relative" }}>
                              <span className="input-prefix">@</span>
                              <input
                                ref={chooseCreatorInputRef}
                                type="text"
                                placeholder="alice"
                                value={creatorSearch}
                                onChange={(e) =>
                                  setCreatorSearch(
                                    e.target.value.replace(/^@+/, "")
                                  )
                                }
                                onKeyDown={(e) => {
                                  if (e.key === "Enter") {
                                    e.preventDefault();
                                    saveCreatorFromInput(true);
                                  }
                                }}
                                className="w-full p-2 border border-gray-200 rounded-lg text-sm creator-search-input pl-9"
                                aria-label="Search creators"
                              />
                              <button
                                type="button"
                                className="input-clear"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setCreatorSearch("");
                                  try {
                                    if (chooseCreatorInputRef.current)
                                      chooseCreatorInputRef.current.focus();
                                  } catch (err) {}
                                }}
                                aria-label="Clear search"
                              >
                                <X className="w-4 h-4" />
                              </button>
                              <button
                                type="button"
                                className="input-save"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  saveCreatorFromInput(true);
                                }}
                                aria-label="Save creator"
                                style={{
                                  position: "absolute",
                                  right: 8,
                                  top: 6,
                                  padding: "4px 8px",
                                  fontSize: 12,
                                  borderRadius: 6,
                                  background: "var(--color-primary)",
                                  color: "#fff",
                                  border: "none",
                                }}
                              >
                                Save
                              </button>
                            </div>

                            <div className="choose-creator-list">
                              {filteredCreators.length === 0 ? (
                                <div className="no-results flex flex-col items-center text-center p-4">
                                  <div
                                    className="no-results-illustration mb-3"
                                    aria-hidden="true"
                                  >
                                    <svg
                                      width="64"
                                      height="64"
                                      viewBox="0 0 64 64"
                                      fill="none"
                                      xmlns="http://www.w3.org/2000/svg"
                                    >
                                      <rect
                                        x="6"
                                        y="10"
                                        width="36"
                                        height="28"
                                        rx="6"
                                        fill="var(--color-cream-bg)"
                                        stroke="rgba(15,23,42,0.06)"
                                      />
                                      <path
                                        d="M44 44L58 58"
                                        stroke="rgba(15,23,42,0.12)"
                                        strokeWidth="3"
                                        strokeLinecap="round"
                                      />
                                      <circle
                                        cx="50"
                                        cy="50"
                                        r="2.5"
                                        fill="var(--brand-gold)"
                                      />
                                    </svg>
                                  </div>
                                  <div className="no-results-title text-sm font-normal">
                                    No creators found
                                  </div>
                                  <div className="no-results-sub text-xs text-gray-400 mt-1">
                                    Try a different username or clear your
                                    search.
                                  </div>
                                </div>
                              ) : (
                                filteredCreators.map((c) => (
                                  <div
                                    key={c.id}
                                    className={"creator-row rounded-md " + (selectedCreator && selectedCreator.id === c.id ? "selected pulse-anim" : "")}
                                    onClick={() => {
                                      setSelectedCreator(c);
                                      setPaymentRole("creator");
                                      trackEvent("creator_selected", {
                                        creatorId: c.id,
                                      });
                                    }}
                                    style={{
                                      display: "flex",
                                      alignItems: "center",
                                      justifyContent: "space-between",
                                      cursor: "pointer",
                                    }}
                                  >
                                    <div
                                      style={{
                                        display: "flex",
                                        alignItems: "center",
                                        gap: 8,
                                      }}
                                    >
                                      <div className="creator-avatar">
                                        {String(c.name)
                                          .replace("@", "")
                                          .charAt(0)
                                          .toUpperCase()}
                                      </div>
                                      <div className="creator-name">
                                        <div className="creator-display">
                                          {String(c.name).replace("@", "")}
                                        </div>
                                        <div className="creator-handle">
                                          {c.name}
                                        </div>
                                      </div>
                                    </div>
                                    <div className="text-xs text-gray-400">
                                      Profile
                                    </div>
                                  </div>
                                ))
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                {/* CTA */}
                <div className="flex items-center justify-between mt-4 gap-3">
                  <div>
                    <button
                      onClick={() => {
                        setPaymentModalOpen(false);
                        setPendingSubmission(null);
                        trackEvent("payment_cancelled");
                      }}
                      className="px-4 py-2 rounded-xl bg-gray-100 text-gray-700"
                    >
                      Cancel
                    </button>
                  </div>
                  <div>
                    <button
                      onClick={() => {
                        const base = paymentAmount;
                        const withRole =
                          paymentRole === "expert"
                            ? Math.round(base * 1.3 * 100) / 100
                            : base;
                        trackEvent("payment_confirmed", {
                          amount: withRole,
                          role: paymentRole,
                          creator: selectedCreator ? selectedCreator.id : null,
                        });
                        continuePendingSubmission(withRole);
                      }}
                      className="px-6 py-3 rounded-xl text-white font-semibold"
                      style={{ backgroundColor: "var(--color-primary)" }}
                    >
                      Pay{" "}
                      {"$" +
                        Number(
                          paymentAmount * (paymentRole === "expert" ? 1.3 : 1)
                        ).toLocaleString(undefined, {
                          minimumFractionDigits: 2,
                          maximumFractionDigits: 2,
                        })}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      <MobileNav active={activeNav} onChange={setActiveNav} />
    </div>
  );
};

export default App;
