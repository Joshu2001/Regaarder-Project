const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/home-DxBb3eDt.js","assets/index-J--XMc-5.js","assets/index-DFIbYeBk.css","assets/index-D81NaDOi.js","assets/Videoplayer-B50ncJKj.js","assets/star-k8AOSrjG.js","assets/trending-up-BKGp63oO.js","assets/clock-BGa7xNqB.js","assets/globe-BSswZjsb.js","assets/book-open-BlZIrF4b.js","assets/video-CVYZB8gD.js","assets/dollar-sign-TXFu5gC0.js","assets/sparkles-COJWI7jQ.js","assets/share-2-CeL5eEF6.js","assets/alert-triangle-Cf9iF486.js","assets/thumbs-down-dGXPdlrB.js","assets/chevron-right-BYc7VePk.js","assets/chevron-left-CBB5eeDK.js","assets/chevron-down-0UbmDaO9.js","assets/pin-Crg713h0.js","assets/bookmark-DgaFaiie.js","assets/crown-B8aucbHK.js","assets/camera-CA9loiMv.js","assets/zap-CaWbWr-r.js","assets/list-plus-B5Ui5pGJ.js","assets/folder-BUfUjCIo.js","assets/users-CAm374lr.js","assets/shield-Dx5YkmD9.js","assets/history-B2tcnVG_.js","assets/gift-BXB__ksz.js","assets/credit-card-BauCF6JW.js","assets/user-Y0NnfhDK.js","assets/pencil-Dw1rFXCt.js","assets/alert-circle-BOVbUWon.js","assets/message-square-Dpaavdog.js","assets/heart-off-DBWStauo.js","assets/heart-BJQVjmA4.js","assets/more-vertical-Dis9VMpB.js","assets/lightbulb-Nrnt1nYy.js","assets/trophy-BHvknXGg.js","assets/search-nPl8B-fm.js","assets/settings-BGw_fMDN.js"])))=>i.map(i=>d[i]);
import{R as v,j as e,g as W,_ as H}from"./index-J--XMc-5.js";import{H as R}from"./history-B2tcnVG_.js";import{M as _,H as O,F as U,P as q}from"./pencil-Dw1rFXCt.js";import{S as K}from"./search-nPl8B-fm.js";import{L as V}from"./lightbulb-Nrnt1nYy.js";import{C as z}from"./check-circle-CZ5oOyI7.js";const P=typeof window<"u"&&localStorage.getItem("regaarder_language")||"English",l=n=>W(n,P),A="watchHistory";let $=null;const T=()=>{try{if(typeof window>"u"||!window.localStorage)return $||[];const n=window.localStorage.getItem(A);return n?JSON.parse(n):[]}catch{try{return $||[]}catch{return[]}}},k=n=>{try{if(typeof window>"u"||!window.localStorage){$=n;try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}return}window.localStorage.setItem(A,JSON.stringify(n));try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}catch{$=n;try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}};function ot(n={}){try{const{videoId:i,userId:u=null,lastWatchedTime:h=0,duration:w=0,isComplete:d=!1}=n,S=n.timestamp?typeof n.timestamp=="string"?n.timestamp:new Date(n.timestamp).toISOString():new Date().toISOString();if(!i)return!1;const m=T(),b=m.findIndex(x=>String(x.videoId)===String(i)),f={videoId:i,userId:u,lastWatchedTime:Number(h)||0,duration:Number(w)||0,timestamp:S,isComplete:!!d};b>=0?m[b]={...m[b],...f}:m.unshift(f),m.length>200&&m.splice(200),k(m);try{const x=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,g=localStorage.getItem("regaarder_token");fetch(`${x}/watch/history`,{method:"POST",headers:{"Content-Type":"application/json",...g?{Authorization:`Bearer ${g}`}:{}},body:JSON.stringify(f)}).then(()=>{try{window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}).catch(()=>{});try{const y={videoId:f.videoId,currentTime:Math.floor(f.lastWatchedTime||0),anonId:localStorage.getItem("playback_anon")};fetch(`${x}/api/playback`,{method:"POST",headers:{"Content-Type":"application/json",...g?{Authorization:`Bearer ${g}`}:{}},body:JSON.stringify(y)}).catch(()=>{})}catch{}}catch{}return!0}catch(i){return console.warn("recordWatchProgress failed",i),!1}}function L(){try{const n=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,i=localStorage.getItem("regaarder_token"),u=(window.fetch,null);return window.fetch&&window.fetch(`${n}/watch/history`,{headers:i?{Authorization:`Bearer ${i}`}:{}}).then(h=>h.json()).then(h=>{h&&Array.isArray(h.history)&&k(h.history)}).catch(()=>{}),T()}catch{return T()}}function Y(){try{typeof window<"u"&&window.localStorage&&window.localStorage.removeItem(A),$=null;try{const n=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,i=localStorage.getItem("regaarder_token");window.fetch&&window.fetch(`${n}/watch/history`,{method:"DELETE",headers:i?{Authorization:`Bearer ${i}`}:{}}).catch(()=>{})}catch{}}catch{$=null}}const at=()=>{const[n,i]=v.useState("Requests"),[u,h]=v.useState(!1),[w,d]=v.useState(()=>L());v.useEffect(()=>{const t=()=>{try{d(L())}catch{}};try{window.addEventListener("watchhistory:updated",t)}catch{}const r=setInterval(t,5e3);return()=>{try{window.removeEventListener("watchhistory:updated",t)}catch{}clearInterval(r)}},[]);const[S,m]=v.useState({}),[b,f]=v.useState("");v.useEffect(()=>{(async()=>{try{const t=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,r=await fetch(`${t}/videos`).then(s=>s.json()).catch(()=>null),o=r&&r.success&&Array.isArray(r.videos)?r.videos:[],a={};o.forEach(s=>{s.id&&(a[`id:${String(s.id)}`]=s),s.videoUrl&&(a[`url:${String(s.videoUrl)}`]=s),s.url&&(a[`url:${String(s.url)}`]=s),s.src&&(a[`url:${String(s.src)}`]=s),s.title&&(a[`title:${String(s.title)}`]=s)}),m(a)}catch{}})()},[w.length]);const x=t=>{try{return S[`id:${String(t.videoId)}`]||S[`url:${String(t.videoId)}`]||null}catch{return null}},g=t=>{try{const r=Number(t.views||0),o=Number(t.comments||0),a=Number(t.shares||0),s=Math.max(r,o,a);return s===r&&r>0?`${r} ${l("views")}`:s===o&&o>0?`${o} ${l("comments")}`:s===a&&a>0?`${a} ${l("shares")}`:null}catch{return null}},y=(t,r=0)=>{try{return`${`${window.location.origin}/videoplayer`}?video=${encodeURIComponent(t)}&t=${Math.max(0,Math.floor(r||0))}`}catch{return t}},E=async t=>{try{const r=x(t)||{},o=await D(t.videoId)||t.videoId,a=o?y(o,t.lastWatchedTime):window.location.href,s=r.title||"Watch this video",p=`${s}${r.author?` • by ${r.author}`:""}`;navigator.share?await navigator.share({title:s,text:p,url:a}):(await(navigator.clipboard&&navigator.clipboard.writeText(a)),alert("Share link copied"))}catch(r){console.warn("share failed",r)}},B=t=>{try{const r=Math.max(0,Math.floor(Number(t)||0)),o=Math.floor(r/60),a=String(r%60).padStart(2,"0");return`${o}:${a}`}catch{return"0:00"}},D=async t=>{try{if(typeof t=="string"&&/^(https?:)?\/\//.test(t))return t;const r=await H(()=>import("./home-DxBb3eDt.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41])),o=r.getVideoById,a=r.VIDEOS||r.default?.VIDEOS||r.homeVideos||r.discoverItems||null;let s=null;return typeof o=="function"&&(s=o(t)),!s&&Array.isArray(a)&&(s=a.find(N=>String(N.id)===String(t))),s?.url||s?.videoUrl||s?.src||null||null}catch{return null}},X=t=>{try{const r=(w||[]).filter(o=>String(o.videoId)!==String(t));d(r),k(r);try{const o=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,a=localStorage.getItem("regaarder_token");window.fetch&&window.fetch(`${o}/watch/history/${encodeURIComponent(t)}`,{method:"DELETE",headers:a?{Authorization:`Bearer ${a}`}:{}}).catch(()=>{})}catch{}}catch{}},F=()=>{try{Y()}catch{}d([]),h(!0),setTimeout(()=>{h(!1)},3e3)};return e.jsxs("div",{className:"flex justify-center min-h-screen w-full bg-white relative",children:[e.jsxs("div",{className:"w-full flex flex-col bg-white overflow-x-hidden",children:[e.jsxs("header",{className:"p-4 border-b border-gray-100 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h1",{className:"text-xl font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5 text-gray-500",strokeWidth:1.5}),e.jsx("span",{children:l("Watch History")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:F,className:"text-sm font-medium hover:opacity-80 transition duration-150",style:{color:"#FFFFFF",backgroundColor:"var(--color-gold)",padding:"6px 12px",borderRadius:"6px"},children:l("Clear All")}),e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900","aria-label":"More",children:e.jsx(_,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center bg-gray-50 border border-gray-200 rounded-md px-2 py-2 w-full max-w-md",children:[e.jsx(K,{className:"w-4 h-4 text-gray-500"}),e.jsx("input",{value:b,onChange:t=>f(t.target.value),placeholder:l("Search"),className:"bg-transparent outline-none text-sm ml-2 w-full"})]}),e.jsxs("p",{className:"text-sm text-gray-500 ml-4 whitespace-nowrap",children:[(w||[]).length," ",l("videos")]})]})]}),e.jsxs("main",{className:"flex-grow flex flex-col items-center justify-start p-6 space-y-6 pb-24",children:[w&&w.length>0?e.jsx("div",{className:"w-full space-y-4",children:Object.entries(w.reduce((t,r)=>{const o=new Date(r.timestamp),a=o.toLocaleDateString("en-US",{weekday:"long"}),s=l(a),p=`${a}-${o.getFullYear()}-${o.getMonth()+1}-${o.getDate()}`;return(t[p]=t[p]||{label:s,date:o,items:[]}).items.push(r),t},{})).sort((t,r)=>r[1].date-t[1].date).map(([t,r])=>e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700 mb-2",children:r.label}),r.items.filter(o=>{const a=x(o)||{},s=a.title||String(o.videoId),p=a.author||"",N=a.requester||"",j=b.trim().toLowerCase();return!j||s.toLowerCase().includes(j)||p.toLowerCase().includes(j)||N.toLowerCase().includes(j)}).map(o=>{const a=x(o)||{},s=a.imageUrl||"https://placehold.co/160x90/efefef/777?text=Video",p=a.title||String(o.videoId),N=a.author||"",j=a.requester||"",M=g(a);return e.jsxs("div",{className:"w-full bg-white rounded-xl shadow-sm border border-gray-100 p-2 flex items-center space-x-3 select-none",onClick:async()=>{try{const c=await D(o.videoId)||o.videoId;c&&(window.location.href=`/videoplayer?video=${encodeURIComponent(c)}&t=${Math.floor(o.lastWatchedTime||0)}`)}catch{}},onTouchStart:c=>{c.currentTarget.dataset.startX=c.touches[0].clientX},onTouchMove:c=>{const C=parseFloat(c.currentTarget.dataset.startX||"0"),I=c.touches[0].clientX-C;c.currentTarget.style.transform=`translateX(${I}px)`},onTouchEnd:c=>{const C=parseFloat(c.currentTarget.dataset.startX||"0"),I=c.changedTouches[0].clientX-C;c.currentTarget.style.transform="",I<-80&&X(o.videoId),c.currentTarget.dataset.startX="0"},children:[e.jsx("img",{src:s,alt:p,className:"w-40 h-24 object-cover rounded-md",onError:c=>{c.currentTarget.src="https://placehold.co/160x90/efefef/777?text=Video"}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 line-clamp-2",children:p}),e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:[N,N&&j?" • ":"",j]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:[l("Left at")," ",B(o.lastWatchedTime)," • ",new Date(o.timestamp).toLocaleString()]}),M&&e.jsx("div",{className:"text-xs text-gray-600 mt-0.5",children:M})]}),e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900","aria-label":"Share",onClick:c=>{c.stopPropagation(),E(o)},children:e.jsx(_,{className:"w-5 h-5"})})]},`${o.videoId}-${o.timestamp}`)})]},t))}):e.jsxs("div",{className:"flex-grow flex flex-col items-center justify-center text-center space-y-4 pt-8",children:[e.jsx(R,{className:"w-16 h-16 text-gray-400",strokeWidth:1}),e.jsx("h2",{className:"text-lg font-semibold text-gray-700",children:l("No watch history")}),e.jsx("p",{className:"text-sm text-gray-500 max-w-xs",children:l("Videos you watch will appear here")})]}),e.jsxs("div",{className:"w-full px-4 py-3 bg-[#F5F5DC] text-gray-700 rounded-xl flex items-start space-x-2",style:{borderColor:"var(--color-gold-light)",borderStyle:"solid",boxShadow:"0 6px 16px rgba(var(--color-gold-rgb,203,138,0),0.06)"},children:[e.jsx(V,{className:"w-4 h-4 mt-0.5 text-[var(--color-gold)] flex-shrink-0"}),e.jsx("p",{className:"text-xs leading-relaxed font-medium",children:l("Swipe right to request similar video • Swipe left to delete")})]})]}),e.jsx(J,{}),u&&e.jsx("div",{className:"fixed top-6 left-0 right-0 flex justify-center z-50",onTouchStart:t=>{t.currentTarget.dataset.dragStartX=t.touches[0].clientX},onTouchMove:t=>{const r=parseFloat(t.currentTarget.dataset.dragStartX||"0"),o=t.touches[0].clientX-r,a=t.currentTarget.querySelector("div");a&&(a.style.transform=`translateX(${o}px)`)},onTouchEnd:t=>{const r=parseFloat(t.currentTarget.dataset.dragStartX||"0"),a=t.changedTouches[0].clientX-r,s=t.currentTarget.querySelector("div");Math.abs(a)>80?h(!1):s&&(s.style.transform="translateX(0)"),t.currentTarget.dataset.dragStartX="0"},children:e.jsxs("div",{className:"bg-white p-3 mx-4 rounded-xl shadow-2xl flex items-center space-x-3 transition-all duration-300 max-w-sm w-full cursor-grab select-none",style:{borderLeft:"4px solid #4CAF50",animation:"toastSlideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1)"},children:[e.jsx(z,{className:"w-6 h-6 text-[#4CAF50] fill-[#4CAF50]/10",strokeWidth:2}),e.jsx("span",{className:"text-base font-medium text-gray-800",children:l("Watch history cleared")})]})})]}),e.jsx("style",{children:`
        @keyframes toastSlideDown {
          from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
      `})]})},J=()=>{const[n,i]=v.useState(null),u=v.useRef(!1),h=[{name:"Home",label:l("Home"),icon:O},{name:"Requests",label:l("Requests"),icon:U},{name:"Ideas",label:l("Ideas"),icon:q},{name:"More",label:l("More"),icon:_}],w="rgb(107 114 128)";return e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-gray-50 border-t border-gray-200 shadow-2xl z-10",style:{paddingTop:"10px",paddingBottom:"calc(44px + env(safe-area-inset-bottom))"},children:e.jsx("div",{className:"flex justify-around max-w-md mx-auto",children:h.map(d=>{const S=d.name===n,m=S?{color:"var(--color-gold)"}:{color:w},b=S?"font-semibold":"font-normal";let f={};S&&(f.textShadow="0 0 8px var(--color-gold-light)");const x=d.icon,g=y=>{try{if(y==="Home"){window.location.href="/home.jsx";return}if(y==="Requests"){window.location.href="/requests.jsx";return}if(y==="Ideas"){window.location.href="/ideas.jsx";return}if(y==="More"){window.location.href="/more.jsx";return}}catch(E){console.warn("Navigation failed",E)}};return e.jsx("div",{className:"relative flex flex-col items-center w-1/4 focus:outline-none",style:f,children:e.jsxs("button",{className:"flex flex-col items-center w-full",onMouseDown:()=>{i(d.name),u.current||(u.current=!0,g(d.name))},onTouchStart:()=>{i(d.name),u.current||(u.current=!0,g(d.name))},onClick:y=>{if(u.current){u.current=!1,y.preventDefault();return}i(d.name),g(d.name)},children:[e.jsx("div",{className:"w-11 h-11 flex items-center justify-center",children:e.jsx(x,{size:22,strokeWidth:1.5,style:m})}),e.jsx("span",{className:`text-[11px] md:text-xs mt-0 leading-none ${b}`,style:m,children:d.label})]})},d.name)})})})};export{Y as clearWatchHistory,at as default,L as getWatchHistory,ot as recordWatchProgress};
