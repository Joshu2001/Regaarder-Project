const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/home-BzDQsHPN.js","assets/index-1DpXXoHL.js","assets/index-B_PKgWR3.css","assets/index-B82StfjO.js","assets/Videoplayer-qXuJdGge.js","assets/FeedbackModal-BPfOH6NA.js","assets/star-D2EYHYdy.js","assets/send-BSSJDnKm.js","assets/trending-up-BIDXJTSo.js","assets/clock-B2-jotsE.js","assets/globe-B99uVdQC.js","assets/book-open-pdmnzHQW.js","assets/video-BJ-covL9.js","assets/StaffLoginModal-BCOEhEPB.js","assets/alert-circle-QzW1DDYP.js","assets/headphones-Dg-cgLz6.js","assets/dollar-sign-YzVn7XhJ.js","assets/sparkles-DWl1PMxr.js","assets/share-2-D0FhcbLL.js","assets/alert-triangle-C9wbxA1L.js","assets/thumbs-down-Bl4d-KCw.js","assets/chevron-right-D5-xo-Sf.js","assets/chevron-left-Cmfyrim9.js","assets/chevron-down-Cc6kj-sK.js","assets/pin-8LpN-c6-.js","assets/bookmark-k9ZjGRWa.js","assets/crown-F0qkLsv3.js","assets/camera-BkpjxCvJ.js","assets/zap-CNvZSHFe.js","assets/list-plus-BKLo_96u.js","assets/folder-C_8ShdQc.js","assets/users-DMrCyk48.js","assets/shield-C-xV4RRL.js","assets/history-DqKJek6L.js","assets/gift-D3bDSsGk.js","assets/credit-card-BOc1Tbfy.js","assets/user--m6dShtv.js","assets/pencil-DPNsTZaI.js","assets/message-square-DjmOuiVp.js","assets/heart-off-D1ssjZ6k.js","assets/heart-DmJfe31-.js","assets/more-vertical-9xfpoC30.js","assets/lightbulb-BFJ0Wfz2.js","assets/home-7xMEDySh.js","assets/trophy-Bf9GtPwq.js","assets/search-RgTytUMR.js","assets/settings-CG_y4ZIL.js","assets/bell-CLDgkf0t.js"])))=>i.map(i=>d[i]);
import{u as W,R as p,j as e,g as H,_ as O}from"./index-1DpXXoHL.js";import{C as U}from"./chevron-left-Cmfyrim9.js";import{S as q}from"./search-RgTytUMR.js";import{M,F as K,P as V}from"./pencil-DPNsTZaI.js";import{H as z}from"./history-DqKJek6L.js";import{L as P}from"./lightbulb-BFJ0Wfz2.js";import{C as Y}from"./check-circle-s3RFwDd8.js";import{H as J}from"./home-7xMEDySh.js";const G=typeof window<"u"&&localStorage.getItem("regaarder_language")||"English",d=n=>H(n,G),_="watchHistory";let $=null;const T=()=>{try{if(typeof window>"u"||!window.localStorage)return $||[];const n=window.localStorage.getItem(_);return n?JSON.parse(n):[]}catch{try{return $||[]}catch{return[]}}},A=n=>{try{if(typeof window>"u"||!window.localStorage){$=n;try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}return}window.localStorage.setItem(_,JSON.stringify(n));try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}catch{$=n;try{window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}};function ct(n={}){try{const{videoId:c,userId:f=null,lastWatchedTime:u=0,duration:S=0,isComplete:i=!1}=n,y=n.timestamp?typeof n.timestamp=="string"?n.timestamp:new Date(n.timestamp).toISOString():new Date().toISOString();if(!c)return!1;const h=T(),b=h.findIndex(v=>String(v.videoId)===String(c)),w={videoId:c,userId:f,lastWatchedTime:Number(u)||0,duration:Number(S)||0,timestamp:y,isComplete:!!i};b>=0?h[b]={...h[b],...w}:h.unshift(w),h.length>200&&h.splice(200),A(h);try{const v=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,m=localStorage.getItem("regaarder_token");fetch(`${v}/watch/history`,{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify(w)}).then(()=>{try{window.dispatchEvent(new CustomEvent("watchhistory:updated"))}catch{}}).catch(()=>{});try{const x={videoId:w.videoId,currentTime:Math.floor(w.lastWatchedTime||0),anonId:localStorage.getItem("playback_anon")};fetch(`${v}/api/playback`,{method:"POST",headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}},body:JSON.stringify(x)}).catch(()=>{})}catch{}}catch{}return!0}catch(c){return console.warn("recordWatchProgress failed",c),!1}}function L(){try{const n=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,c=localStorage.getItem("regaarder_token"),f=(window.fetch,null);return window.fetch&&window.fetch(`${n}/watch/history`,{headers:c?{Authorization:`Bearer ${c}`}:{}}).then(u=>u.json()).then(u=>{u&&Array.isArray(u.history)&&A(u.history)}).catch(()=>{}),T()}catch{return T()}}function Q(){try{typeof window<"u"&&window.localStorage&&window.localStorage.removeItem(_),$=null;try{const n=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,c=localStorage.getItem("regaarder_token");window.fetch&&window.fetch(`${n}/watch/history`,{method:"DELETE",headers:c?{Authorization:`Bearer ${c}`}:{}}).catch(()=>{})}catch{}}catch{$=null}}const lt=()=>{const n=W(),[c,f]=p.useState("Requests"),[u,S]=p.useState(!1),[i,y]=p.useState(()=>L());p.useEffect(()=>{const t=()=>{try{y(L())}catch{}};try{window.addEventListener("watchhistory:updated",t)}catch{}const r=setInterval(t,5e3);return()=>{try{window.removeEventListener("watchhistory:updated",t)}catch{}clearInterval(r)}},[]);const[h,b]=p.useState({}),[w,v]=p.useState("");p.useEffect(()=>{(async()=>{try{const t=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,r=await fetch(`${t}/videos`).then(s=>s.json()).catch(()=>null),o=r&&r.success&&Array.isArray(r.videos)?r.videos:[],a={};o.forEach(s=>{s.id&&(a[`id:${String(s.id)}`]=s),s.videoUrl&&(a[`url:${String(s.videoUrl)}`]=s),s.url&&(a[`url:${String(s.url)}`]=s),s.src&&(a[`url:${String(s.src)}`]=s),s.title&&(a[`title:${String(s.title)}`]=s)}),b(a)}catch{}})()},[i.length]);const m=t=>{try{return h[`id:${String(t.videoId)}`]||h[`url:${String(t.videoId)}`]||null}catch{return null}},x=t=>{try{const r=Number(t.views||0),o=Number(t.comments||0),a=Number(t.shares||0),s=Math.max(r,o,a);return s===r&&r>0?`${r} ${d("views")}`:s===o&&o>0?`${o} ${d("comments")}`:s===a&&a>0?`${a} ${d("shares")}`:null}catch{return null}},E=(t,r=0)=>{try{return`${`${window.location.origin}/videoplayer`}?video=${encodeURIComponent(t)}&t=${Math.max(0,Math.floor(r||0))}`}catch{return t}},R=async t=>{try{const r=m(t)||{},o=await k(t.videoId)||t.videoId,a=o?E(o,t.lastWatchedTime):window.location.href,s=r.title||"Watch this video",g=`${s}${r.author?` • by ${r.author}`:""}`;navigator.share?await navigator.share({title:s,text:g,url:a}):(await(navigator.clipboard&&navigator.clipboard.writeText(a)),alert("Share link copied"))}catch(r){console.warn("share failed",r)}},B=t=>{try{const r=Math.max(0,Math.floor(Number(t)||0)),o=Math.floor(r/60),a=String(r%60).padStart(2,"0");return`${o}:${a}`}catch{return"0:00"}},k=async t=>{try{if(typeof t=="string"&&/^(https?:)?\/\//.test(t))return t;const r=await O(()=>import("./home-BzDQsHPN.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47])),o=r.getVideoById,a=r.VIDEOS||r.default?.VIDEOS||r.homeVideos||r.discoverItems||null;let s=null;return typeof o=="function"&&(s=o(t)),!s&&Array.isArray(a)&&(s=a.find(j=>String(j.id)===String(t))),s?.url||s?.videoUrl||s?.src||null||null}catch{return null}},X=t=>{try{const r=(i||[]).filter(o=>String(o.videoId)!==String(t));y(r),A(r);try{const o=window&&window.__BACKEND_URL__||`${window.location.protocol}//${window.location.hostname}:4000`,a=localStorage.getItem("regaarder_token");window.fetch&&window.fetch(`${o}/watch/history/${encodeURIComponent(t)}`,{method:"DELETE",headers:a?{Authorization:`Bearer ${a}`}:{}}).catch(()=>{})}catch{}}catch{}},F=()=>{try{Q()}catch{}y([]),S(!0),setTimeout(()=>{S(!1)},3e3)};return e.jsxs("div",{className:"flex justify-center min-h-screen w-full bg-white relative",children:[e.jsxs("div",{className:"w-full flex flex-col bg-white overflow-x-hidden",children:[e.jsx("header",{className:"bg-white border-b border-gray-100 p-4 sticky top-0 z-20",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(U,{className:"w-6 h-6 text-gray-700 cursor-pointer transition hover:text-gray-900",onClick:()=>n(-1)}),e.jsx("h1",{className:"text-xl font-semibold text-gray-800",children:d("Watch History")})]})}),e.jsxs("div",{className:"p-4 space-y-3 border-b border-gray-100",children:[e.jsx("button",{onClick:F,className:"text-sm font-medium hover:opacity-80 transition duration-150",style:{color:"#FFFFFF",backgroundColor:"var(--color-gold)",padding:"6px 12px",borderRadius:"6px"},children:d("Clear All")}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center bg-gray-50 border border-gray-200 rounded-md px-2 py-2 w-full max-w-md",children:[e.jsx(q,{className:"w-4 h-4 text-gray-500"}),e.jsx("input",{value:w,onChange:t=>v(t.target.value),placeholder:d("Search"),className:"bg-transparent outline-none text-sm ml-2 w-full"})]}),e.jsxs("p",{className:"text-sm text-gray-500 ml-4 whitespace-nowrap",children:[(i||[]).length," ",d("videos")]})]})]}),e.jsxs("main",{className:"flex-grow flex flex-col items-center justify-start p-6 space-y-6 pb-24",children:[i&&i.length>0?e.jsx("div",{className:"w-full space-y-4",children:Object.entries(i.reduce((t,r)=>{const o=new Date(r.timestamp),a=o.toLocaleDateString("en-US",{weekday:"long"}),s=d(a),g=`${a}-${o.getFullYear()}-${o.getMonth()+1}-${o.getDate()}`;return(t[g]=t[g]||{label:s,date:o,items:[]}).items.push(r),t},{})).sort((t,r)=>r[1].date-t[1].date).map(([t,r])=>e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700 mb-2",children:r.label}),r.items.filter(o=>{const a=m(o)||{},s=a.title||String(o.videoId),g=a.author||"",j=a.requester||"",N=w.trim().toLowerCase();return!N||s.toLowerCase().includes(N)||g.toLowerCase().includes(N)||j.toLowerCase().includes(N)}).map(o=>{const a=m(o)||{},s=a.imageUrl||"https://placehold.co/160x90/efefef/777?text=Video",g=a.title||String(o.videoId),j=a.author||"",N=a.requester||"",D=x(a);return e.jsxs("div",{className:"w-full bg-white rounded-xl shadow-sm border border-gray-100 p-2 flex items-center space-x-3 select-none",onClick:async()=>{try{const l=await k(o.videoId)||o.videoId;l&&(window.location.href=`/videoplayer?video=${encodeURIComponent(l)}&t=${Math.floor(o.lastWatchedTime||0)}`)}catch{}},onTouchStart:l=>{l.currentTarget.dataset.startX=l.touches[0].clientX},onTouchMove:l=>{const C=parseFloat(l.currentTarget.dataset.startX||"0"),I=l.touches[0].clientX-C;l.currentTarget.style.transform=`translateX(${I}px)`},onTouchEnd:l=>{const C=parseFloat(l.currentTarget.dataset.startX||"0"),I=l.changedTouches[0].clientX-C;l.currentTarget.style.transform="",I<-80&&X(o.videoId),l.currentTarget.dataset.startX="0"},children:[e.jsx("img",{src:s,alt:g,className:"w-40 h-24 object-cover rounded-md",onError:l=>{l.currentTarget.src="https://placehold.co/160x90/efefef/777?text=Video"}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 line-clamp-2",children:g}),e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:[j,j&&N?" • ":"",N]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-0.5",children:[d("Left at")," ",B(o.lastWatchedTime)," • ",new Date(o.timestamp).toLocaleString()]}),D&&e.jsx("div",{className:"text-xs text-gray-600 mt-0.5",children:D})]}),e.jsx("button",{className:"p-2 text-gray-600 hover:text-gray-900","aria-label":"Share",onClick:l=>{l.stopPropagation(),R(o)},children:e.jsx(M,{className:"w-5 h-5"})})]},`${o.videoId}-${o.timestamp}`)})]},t))}):e.jsxs("div",{className:"flex-grow flex flex-col items-center justify-center text-center space-y-4 pt-8",children:[e.jsx(z,{className:"w-16 h-16 text-gray-400",strokeWidth:1}),e.jsx("h2",{className:"text-lg font-semibold text-gray-700",children:d("No watch history")}),e.jsx("p",{className:"text-sm text-gray-500 max-w-xs",children:d("Videos you watch will appear here")})]}),e.jsxs("div",{className:"w-full px-4 py-3 bg-[#F5F5DC] text-gray-700 rounded-xl flex items-start space-x-2",style:{borderColor:"var(--color-gold-light)",borderStyle:"solid",boxShadow:"0 6px 16px rgba(var(--color-gold-rgb,203,138,0),0.06)"},children:[e.jsx(P,{className:"w-4 h-4 mt-0.5 text-[var(--color-gold)] flex-shrink-0"}),e.jsx("p",{className:"text-xs leading-relaxed font-medium",children:d("Swipe right to request similar video • Swipe left to delete")})]})]}),e.jsx(Z,{}),u&&e.jsx("div",{className:"fixed top-6 left-0 right-0 flex justify-center z-50",onTouchStart:t=>{t.currentTarget.dataset.dragStartX=t.touches[0].clientX},onTouchMove:t=>{const r=parseFloat(t.currentTarget.dataset.dragStartX||"0"),o=t.touches[0].clientX-r,a=t.currentTarget.querySelector("div");a&&(a.style.transform=`translateX(${o}px)`)},onTouchEnd:t=>{const r=parseFloat(t.currentTarget.dataset.dragStartX||"0"),a=t.changedTouches[0].clientX-r,s=t.currentTarget.querySelector("div");Math.abs(a)>80?S(!1):s&&(s.style.transform="translateX(0)"),t.currentTarget.dataset.dragStartX="0"},children:e.jsxs("div",{className:"bg-white p-3 mx-4 rounded-xl shadow-2xl flex items-center space-x-3 transition-all duration-300 max-w-sm w-full cursor-grab select-none",style:{borderLeft:"4px solid #4CAF50",animation:"toastSlideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1)"},children:[e.jsx(Y,{className:"w-6 h-6 text-[#4CAF50] fill-[#4CAF50]/10",strokeWidth:2}),e.jsx("span",{className:"text-base font-medium text-gray-800",children:d("Watch history cleared")})]})})]}),e.jsx("style",{children:`
        @keyframes toastSlideDown {
          from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
      `})]})},Z=()=>{const[n,c]=p.useState(null),f=p.useRef(!1),u=[{name:"Home",label:d("Home"),icon:J},{name:"Requests",label:d("Requests"),icon:K},{name:"Ideas",label:d("Ideas"),icon:V},{name:"More",label:d("More"),icon:M}],S="rgb(107 114 128)";return e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-gray-50 border-t border-gray-200 shadow-2xl z-10",style:{paddingTop:"10px",paddingBottom:"calc(44px + env(safe-area-inset-bottom))"},children:e.jsx("div",{className:"flex justify-around max-w-md mx-auto",children:u.map(i=>{const y=i.name===n,h=y?{color:"var(--color-gold)"}:{color:S},b=y?"font-semibold":"font-normal";let w={};y&&(w.textShadow="0 0 8px var(--color-gold-light)");const v=i.icon,m=x=>{try{if(x==="Home"){window.location.href="/home.jsx";return}if(x==="Requests"){window.location.href="/requests.jsx";return}if(x==="Ideas"){window.location.href="/ideas";return}if(x==="More"){window.location.href="/more.jsx";return}}catch(E){console.warn("Navigation failed",E)}};return e.jsx("div",{className:"relative flex flex-col items-center w-1/4 focus:outline-none",style:w,children:e.jsxs("button",{className:"flex flex-col items-center w-full",onMouseDown:()=>{c(i.name),f.current||(f.current=!0,m(i.name))},onTouchStart:()=>{c(i.name),f.current||(f.current=!0,m(i.name))},onClick:x=>{if(f.current){f.current=!1,x.preventDefault();return}c(i.name),m(i.name)},children:[e.jsx("div",{className:"w-11 h-11 flex items-center justify-center",children:e.jsx(v,{size:22,strokeWidth:1.5,style:h})}),e.jsx("span",{className:`text-[11px] md:text-xs mt-0 leading-none ${b}`,style:h,children:i.label})]})},i.name)})})})};export{Q as clearWatchHistory,lt as default,L as getWatchHistory,ct as recordWatchProgress};
